<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¹„ë””ì˜¤ í¸ì§‘ê¸° - ë‚´ë¶€ ì‘ì—…ìš©</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ¬</text></svg>">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Malgun Gothic', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .content {
            padding: 30px;
        }

        .input-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
        }

        .input-section h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .input-group input[type="file"],
        .input-group input[type="text"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        .input-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin: 5px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .btn-success {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        .video-section {
            margin-bottom: 30px;
            text-align: center;
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .video-wrapper {
            position: relative;
            display: inline-block;
        }

        #videoPlayer {
            width: 100%;
            max-width: 800px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            background: #000;
            display: block;
        }

        #previewCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            border-radius: 15px;
            z-index: 10;
        }

        .controls {
            margin-top: 20px;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
        }

        .status {
            background: #e3f2fd;
            border-left: 4px solid #2196F3;
            padding: 15px;
            margin-top: 20px;
            border-radius: 8px;
            display: none;
        }

        .status.show {
            display: block;
        }

        .status.success {
            background: #e8f5e9;
            border-color: #4caf50;
        }

        .status.error {
            background: #ffebee;
            border-color: #f44336;
        }

        .status.warning {
            background: #fff3e0;
            border-color: #ff9800;
        }

        .progress-container {
            margin-top: 20px;
            display: none;
        }

        .progress-container.show {
            display: block;
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: #f0f0f0;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 0.9em;
        }

        #canvas {
            display: none;
        }

        #previewCanvas {
            display: block;
        }

        .playback-speed-control {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .playback-speed-control label {
            font-weight: 600;
            color: #667eea;
            font-size: 1em;
        }

        .playback-speed-control select {
            padding: 8px 15px;
            border: 2px solid #667eea;
            border-radius: 6px;
            font-size: 1em;
            font-weight: 600;
            background: white;
            color: #333;
            cursor: pointer;
            transition: all 0.3s;
        }

        .playback-speed-control select:hover {
            background: #f0f0ff;
            border-color: #764ba2;
        }

        .playback-speed-control select:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
        }

        /* íƒ€ì„ë¼ì¸ í•¸ë“¤ ìŠ¤íƒ€ì¼ */
        .timeline-handle {
            transition: all 0.2s ease;
        }

        .timeline-handle:hover {
            background: #45a049 !important;
            transform: scaleX(1.1);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3) !important;
        }

        .timeline-handle:active {
            background: #3d8b40 !important;
            transform: scaleX(1.05);
        }

        .gif-controls {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            margin-top: 20px;
        }

        .gif-controls h3 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .gif-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .gif-options label {
            display: flex;
            flex-direction: column;
            font-weight: 600;
            color: #333;
        }

        .gif-options input,
        .gif-options select {
            margin-top: 5px;
            padding: 8px;
            border: 2px solid #ddd;
            border-radius: 6px;
            width: 100%;
        }

        .gif-options small {
            display: block;
            font-size: 0.85em;
        }

        .folder-selector {
            background: #e8f4f8;
            border: 2px dashed #667eea;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .folder-selector.active {
            background: #d4edda;
            border-color: #28a745;
        }

        .folder-info {
            flex: 1;
        }

        .folder-info .label {
            font-weight: 600;
            color: #667eea;
            margin-bottom: 5px;
        }

        .folder-info .path {
            color: #666;
            font-size: 0.9em;
        }

        .btn-folder {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            white-space: nowrap;
        }

        .btn-folder:hover {
            background: #5568d3;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8em;
            }

            .controls {
                flex-direction: column;
            }

            .btn {
                width: 100%;
            }
        }

        /* ì €ì¥ ì•Œë¦¼ ì• ë‹ˆë©”ì´ì…˜ */
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.8);
            }
            to {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
        }

        @keyframes slideOut {
            from {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
            to {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.8);
            }
        }

        /* ë¹„ë””ì˜¤ ê°¤ëŸ¬ë¦¬ ìŠ¤íƒ€ì¼ */
        .video-gallery {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 12px;
            border: 2px dashed #ddd;
        }

        .gallery-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .gallery-title {
            font-size: 1.1em;
            font-weight: 600;
            color: #333;
        }

        .gallery-count {
            font-size: 0.9em;
            color: #666;
            background: #fff;
            padding: 5px 12px;
            border-radius: 20px;
        }

        .video-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            max-height: 400px;
            overflow-y: auto;
        }

        .video-card {
            position: relative;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            border: 2px solid transparent;
        }

        .video-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
            border-color: #667eea;
        }

        .video-card.selected {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .video-thumbnail {
            width: 100%;
            height: 120px;
            object-fit: cover;
            background: #e9ecef;
        }

        .video-info {
            padding: 10px;
        }

        .video-name {
            font-size: 0.85em;
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .video-duration {
            font-size: 0.75em;
            color: #666;
        }

        .gallery-empty {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }

        .gallery-empty-icon {
            font-size: 3em;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¬ ë¹„ë””ì˜¤ í¸ì§‘ê¸°</h1>
            <p>ì—­ì¬ìƒ â€¢ ìº¡ì²˜ â€¢ GIF ìƒì„±</p>
        </div>

        <div class="content">
            <!-- ë¹„ë””ì˜¤ ì…ë ¥ ì„¹ì…˜ -->
            <div class="input-section">
                <h2>ğŸ“ ë¹„ë””ì˜¤ ë¶ˆëŸ¬ì˜¤ê¸°</h2>

                <div class="input-group">
                    <label for="fileInput">ë¡œì»¬ íŒŒì¼ ì„ íƒ</label>
                    <input type="file" id="fileInput" accept="video/*">
                </div>

                <div class="input-group">
                    <label for="urlInput">ë˜ëŠ” ë¹„ë””ì˜¤ URL ì…ë ¥</label>
                    <input type="text" id="urlInput" placeholder="https://example.com/video.mp4">
                    <button class="btn" onclick="loadVideoFromURL()" style="margin-top: 10px;">URLì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸°</button>
                </div>

                <div class="input-group" style="margin-top: 15px;">
                    <button class="btn" onclick="openVideoFolder()" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); width: 100%;">
                        ğŸ“‚ ë¹„ë””ì˜¤ í´ë” ì—´ê¸°
                    </button>
                    <small style="color: #666; margin-top: 5px; display: block;">í´ë” ë‚´ ëª¨ë“  ë¹„ë””ì˜¤ë¥¼ ê°¤ëŸ¬ë¦¬ë¡œ í‘œì‹œí•©ë‹ˆë‹¤</small>
                </div>

                <!-- ë¹„ë””ì˜¤ ê°¤ëŸ¬ë¦¬ -->
                <div class="video-gallery" id="videoGallery" style="display: none;">
                    <div class="gallery-header">
                        <div class="gallery-title">ğŸ“¹ ë¹„ë””ì˜¤ ê°¤ëŸ¬ë¦¬</div>
                        <div class="gallery-count" id="galleryCount">0ê°œ ë¹„ë””ì˜¤</div>
                    </div>
                    <div class="video-grid" id="videoGrid">
                        <div class="gallery-empty">
                            <div class="gallery-empty-icon">ğŸ¬</div>
                            <div>ë¹„ë””ì˜¤ í´ë”ë¥¼ ì„ íƒí•˜ì„¸ìš”</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ì €ì¥ í´ë” ì„ íƒ ì„¹ì…˜ -->
            <div class="folder-selector" id="folderSelector">
                <div class="folder-info">
                    <div class="label">ğŸ’¾ ì €ì¥ ìœ„ì¹˜</div>
                    <div class="path" id="folderPath">ë¸Œë¼ìš°ì € ë‹¤ìš´ë¡œë“œ í´ë” (ê¸°ë³¸)</div>
                </div>
                <button class="btn-folder" onclick="selectSaveFolder()">ğŸ“‚ í´ë” ì„ íƒ</button>
            </div>

            <!-- ë¹„ë””ì˜¤ í”Œë ˆì´ì–´ ì„¹ì…˜ -->
            <div class="video-section" id="videoSection">
                <div class="video-wrapper">
                    <video id="videoPlayer" controls crossorigin="anonymous">
                        ë¹„ë””ì˜¤ë¥¼ ë¶ˆëŸ¬ì™€ì£¼ì„¸ìš”.
                    </video>
                    <canvas id="previewCanvas"></canvas>
                </div>
                <canvas id="canvas"></canvas>

                <!-- íŒŒì›ŒìŠ¬ë¡œìš° ì¬ìƒ í† ê¸€ ë²„íŠ¼ -->
                <div style="margin-top: 10px;">
                    <button class="btn" onclick="togglePowerSlowPlayback()" id="powerSlowToggleBtn" disabled style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); font-weight: bold; font-size: 16px; padding: 10px 20px;">
                        âš¡ íŒŒì›ŒìŠ¬ë¡œìš° ì¬ìƒ OFF
                    </button>
                    <span id="powerSlowStatus" style="margin-left: 10px; color: #666; font-size: 14px;">ì¬ìƒ ì¤‘ ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ì‹¤ì‹œê°„ ìŠ¬ë¡œìš° ëª¨ì…˜ (4ë°° ìŠ¬ë¡œìš°, ë‹¨ìˆœ ë³´ê°„ 4ê°œ í”„ë ˆì„)</span>
                </div>

                <!-- íƒ€ì„ë¼ì¸ ë²”ìœ„ ì„ íƒ (êµ¬ê°„ ì˜ë¼ë‚´ê¸°) -->
                <div id="timelineRangeSelector" style="display: none; margin-top: 5px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h4 style="margin: 0; color: #333;">âœ‚ï¸ êµ¬ê°„ ì„ íƒ</h4>
                        <button class="btn" onclick="closeTrimMode()" style="padding: 5px 15px; font-size: 12px;">ë‹«ê¸°</button>
                    </div>
                    <div style="color: #666; font-size: 14px; margin-bottom: 10px;">
                        ì„ íƒ êµ¬ê°„: <span id="rangeTimeDisplay" style="font-weight: bold; color: #4CAF50;">0:00 ~ 0:00</span>
                        (ê¸¸ì´: <span id="rangeDurationDisplay" style="font-weight: bold; color: #2196F3;">0:00</span>)
                    </div>

                    <!-- íƒ€ì„ë¼ì¸ ë°” -->
                    <div id="timelineContainer" style="position: relative; height: 60px; background: #ddd; border-radius: 4px; cursor: pointer; overflow: hidden;">
                        <!-- ì„ íƒëœ ë²”ìœ„ í•˜ì´ë¼ì´íŠ¸ -->
                        <div id="selectedRange" style="position: absolute; height: 100%; background: rgba(76, 175, 80, 0.3); border-left: 3px solid #4CAF50; border-right: 3px solid #4CAF50; pointer-events: none;"></div>

                        <!-- ì‹œì‘ í•¸ë“¤ -->
                        <div id="startHandle" class="timeline-handle"
                             onmousedown="handleDragStart(event, 'start')"
                             ontouchstart="handleTouchStart(event, 'start')"
                             style="position: absolute; left: 0; top: 0; width: 40px; height: 100%; background: #4CAF50; cursor: ew-resize; display: flex; align-items: center; justify-content: center; color: white; font-size: 24px; user-select: none; z-index: 10; box-shadow: 0 2px 8px rgba(0,0,0,0.2); touch-action: none;">
                            â—€
                        </div>

                        <!-- ì¢…ë£Œ í•¸ë“¤ -->
                        <div id="endHandle" class="timeline-handle"
                             onmousedown="handleDragStart(event, 'end')"
                             ontouchstart="handleTouchStart(event, 'end')"
                             style="position: absolute; left: 100%; top: 0; width: 40px; height: 100%; background: #4CAF50; cursor: ew-resize; display: flex; align-items: center; justify-content: center; color: white; font-size: 24px; user-select: none; z-index: 10; box-shadow: 0 2px 8px rgba(0,0,0,0.2); margin-left: -40px; touch-action: none;">
                            â–¶
                        </div>
                    </div>

                    <!-- ì˜µì…˜ -->
                    <div style="margin-top: 15px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <label style="display: flex; flex-direction: column;">
                            í”„ë ˆì„ ë ˆì´íŠ¸
                            <select id="trimFpsIntegrated" style="margin-top: 5px;">
                                <option value="24">24 fps</option>
                                <option value="30" selected>30 fps</option>
                                <option value="60">60 fps</option>
                            </select>
                        </label>
                        <label style="display: flex; flex-direction: column;">
                            ë¹„ë””ì˜¤ í’ˆì§ˆ
                            <select id="trimQualityIntegrated" style="margin-top: 5px;">
                                <option value="10000000">ìµœê³  (10 Mbps)</option>
                                <option value="8000000" selected>ê³ í’ˆì§ˆ (8 Mbps)</option>
                                <option value="5000000">ì¤‘ê°„ (5 Mbps)</option>
                                <option value="3000000">ë‚®ìŒ (3 Mbps)</option>
                            </select>
                        </label>
                    </div>

                    <button class="btn" onclick="startTrimVideoIntegrated()" style="margin-top: 15px; width: 100%;">
                        âœ¨ ì„ íƒí•œ êµ¬ê°„ ì˜ë¼ë‚´ê¸°
                    </button>
                </div>
            </div>

            <!-- ì»¨íŠ¸ë¡¤ ë²„íŠ¼ -->
            <div class="controls">
                <button class="btn btn-success" onclick="captureFrame('png')" id="capturePngBtn" disabled>
                    ğŸ“¸ PNG ìº¡ì²˜
                </button>
                <button class="btn btn-success" onclick="captureFrame('jpg')" id="captureJpgBtn" disabled>
                    ğŸ“¸ JPG ìº¡ì²˜
                </button>
                <button class="btn btn-secondary" onclick="showIntervalCaptureOptions()" id="intervalCaptureBtn" disabled>
                    ğŸ¬ ê°„ê²© ìº¡ì²˜
                </button>
                <button class="btn btn-secondary" onclick="showGifOptions()" id="gifBtn" disabled>
                    ğŸï¸ GIF ìƒì„±
                </button>
                <button class="btn" onclick="showTrimOptions()" id="trimBtn" disabled>
                    âœ‚ï¸ êµ¬ê°„ ì˜ë¼ë‚´ê¸°
                </button>
                <button class="btn btn-success" onclick="showThumbnailOptions()" id="thumbnailBtn" disabled>
                    ğŸ–¼ï¸ ì¸ë„¤ì¼ ìƒì„±
                </button>
                <button class="btn" onclick="showSlowMotionOptions()" id="slowMotionBtn" disabled style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    â±ï¸ ìŠ¬ë¡œìš° ëª¨ì…˜
                </button>
                <button class="btn" onclick="showReverseOptions()" id="reverseBtn" disabled>
                    âª ì—­ì¬ìƒ ë¹„ë””ì˜¤ ìƒì„±
                </button>
                <button class="btn" onclick="showHighQualityOptions()" id="highQualityBtn" disabled style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                    âš¡ ê³ í™”ì§ˆ ë¹„ë””ì˜¤ ìƒì„±
                </button>
            </div>

            <!-- ì˜µì…˜ í† ê¸€ ë²„íŠ¼ -->
            <div class="controls" style="margin-top: 10px;">
                <button class="btn" onclick="toggleFilters()" id="filterToggleBtn" disabled style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    ğŸ¨ í•„í„° ì¡°ì ˆ â–¼
                </button>
                <button class="btn" onclick="toggleTextOptions()" id="textToggleBtn" disabled style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                    âœï¸ í…ìŠ¤íŠ¸ ì¶”ê°€ â–¼
                </button>
            </div>

            <!-- ì¬ìƒì†ë„ ì¡°ì ˆ -->
            <div class="playback-speed-control" style="margin-top: 10px;">
                <label for="playbackSpeed">âš¡ ì¬ìƒ ì†ë„:</label>
                <select id="playbackSpeed" onchange="changePlaybackSpeed()">
                    <option value="0.25">0.25x</option>
                    <option value="0.5">0.5x</option>
                    <option value="0.75">0.75x</option>
                    <option value="1" selected>1x (ê¸°ë³¸)</option>
                    <option value="1.25">1.25x</option>
                    <option value="1.5">1.5x</option>
                    <option value="1.75">1.75x</option>
                    <option value="2">2x</option>
                </select>
            </div>

            <!-- í•„í„° ì¡°ì ˆ ì˜µì…˜ -->
            <div class="gif-controls" id="filterControls" style="margin-bottom: 15px; display: none;">
                <h3>ğŸ¨ ë¹„ë””ì˜¤ í•„í„° ì¡°ì ˆ (ì„ íƒì‚¬í•­)</h3>
                <div class="gif-options">
                    <label>
                        ë°ê¸° (Brightness)
                        <input type="range" id="filterBrightness" min="0" max="200" value="100" step="1">
                        <small style="color: #666; margin-top: 5px;">í˜„ì¬: <span id="brightnessValue">100</span>%</small>
                    </label>
                    <label>
                        ëŒ€ë¹„ (Contrast)
                        <input type="range" id="filterContrast" min="0" max="200" value="100" step="1">
                        <small style="color: #666; margin-top: 5px;">í˜„ì¬: <span id="contrastValue">100</span>%</small>
                    </label>
                    <label>
                        ì±„ë„ (Saturation)
                        <input type="range" id="filterSaturation" min="0" max="200" value="100" step="1">
                        <small style="color: #666; margin-top: 5px;">í˜„ì¬: <span id="saturationValue">100</span>%</small>
                    </label>
                    <label>
                        ìƒ‰ì¡° (Hue Rotate)
                        <input type="range" id="filterHue" min="0" max="360" value="0" step="1">
                        <small style="color: #666; margin-top: 5px;">í˜„ì¬: <span id="hueValue">0</span>Â°</small>
                    </label>
                    <label>
                        ì„ ëª…ë„ (Blur)
                        <input type="range" id="filterBlur" min="0" max="10" value="0" step="0.5">
                        <small style="color: #666; margin-top: 5px;">í˜„ì¬: <span id="blurValue">0</span>px</small>
                    </label>
                    <label>
                        ê·¸ë ˆì´ìŠ¤ì¼€ì¼
                        <input type="range" id="filterGrayscale" min="0" max="100" value="0" step="1">
                        <small style="color: #666; margin-top: 5px;">í˜„ì¬: <span id="grayscaleValue">0</span>%</small>
                    </label>
                </div>
                <div style="margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="btn" onclick="applyFilterPreset('none')" style="background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);">
                        ğŸ”„ í•„í„° ì´ˆê¸°í™”
                    </button>
                    <button class="btn" onclick="applyFilterPreset('bw')" style="background: linear-gradient(135deg, #34495e 0%, #2c3e50 100%);">
                        âš« í‘ë°±
                    </button>
                    <button class="btn" onclick="applyFilterPreset('sepia')" style="background: linear-gradient(135deg, #d4a574 0%, #a67c52 100%);">
                        ğŸŸ¤ ì„¸í”¼ì•„
                    </button>
                    <button class="btn" onclick="applyFilterPreset('vintage')" style="background: linear-gradient(135deg, #e8c4a0 0%, #c9a882 100%);">
                        ğŸ“· ë¹ˆí‹°ì§€
                    </button>
                    <button class="btn" onclick="applyFilterPreset('vivid')" style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);">
                        ğŸŒˆ ì„ ëª…í•˜ê²Œ
                    </button>
                </div>
            </div>

            <!-- ìº¡ì²˜ í…ìŠ¤íŠ¸ ì˜µì…˜ -->
            <div class="gif-controls" id="textControls" style="margin-bottom: 15px; display: none;">
                <h3>âœï¸ ìº¡ì²˜ í…ìŠ¤íŠ¸ ì¶”ê°€ (ì„ íƒì‚¬í•­)</h3>
                <p style="color: #666; font-size: 14px; margin-bottom: 15px; padding: 10px; background: #f0f8ff; border-left: 4px solid #4CAF50; border-radius: 4px;">
                    ğŸ’¡ <strong>ì‚¬ìš©ë²•:</strong> ì•„ë˜ì—ì„œ í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•œ í›„ <strong>ğŸ“¸ PNG/JPG ìº¡ì²˜</strong> ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ì…ë ¥í•œ í…ìŠ¤íŠ¸ê°€ ì´ë¯¸ì§€ì— ìë™ìœ¼ë¡œ í¬í•¨ë˜ì–´ ì €ì¥ë©ë‹ˆë‹¤.
                </p>
                <div class="gif-options">
                    <label>
                        í…ìŠ¤íŠ¸ ë‚´ìš©
                        <input type="text" id="captureText" placeholder="ì˜ˆ: 2024-01-15 ì¤‘ìš” ì¥ë©´">
                    </label>
                    <label>
                        í°íŠ¸ í¬ê¸°
                        <select id="captureFontSize">
                            <option value="24">ì‘ê²Œ (24px)</option>
                            <option value="36" selected>ë³´í†µ (36px)</option>
                            <option value="48">í¬ê²Œ (48px)</option>
                            <option value="64">ë§¤ìš° í¬ê²Œ (64px)</option>
                        </select>
                    </label>
                    <label>
                        í…ìŠ¤íŠ¸ ìƒ‰ìƒ
                        <select id="captureTextColor">
                            <option value="#FFFFFF" selected>í°ìƒ‰</option>
                            <option value="#000000">ê²€ì •</option>
                            <option value="#FF0000">ë¹¨ê°•</option>
                            <option value="#00FF00">ì´ˆë¡</option>
                            <option value="#0000FF">íŒŒë‘</option>
                            <option value="#FFFF00">ë…¸ë‘</option>
                        </select>
                    </label>
                    <label>
                        í…ìŠ¤íŠ¸ ìœ„ì¹˜
                        <select id="captureTextPosition">
                            <option value="top">ìƒë‹¨</option>
                            <option value="middle">ì¤‘ì•™</option>
                            <option value="bottom" selected>í•˜ë‹¨</option>
                        </select>
                    </label>
                    <label>
                        í…ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼
                        <select id="captureTextStyle">
                            <option value="transparent" selected>íˆ¬ëª… (ë°°ê²½ ì—†ìŒ)</option>
                            <option value="background">ë°°ê²½ ìˆìŒ</option>
                        </select>
                    </label>
                </div>

                <!-- íƒ€ì„ìŠ¤íƒ¬í”„ ìë™ í‘œì‹œ ì˜µì…˜ -->
                <div style="margin-top: 15px; padding-top: 15px; border-top: 2px dashed #ddd;">
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                        <input type="checkbox" id="showTimestamp" style="width: auto; cursor: pointer;">
                        <span style="font-weight: 600;">â±ï¸ íƒ€ì„ìŠ¤íƒ¬í”„ ìë™ í‘œì‹œ (ìš°ì¸¡ í•˜ë‹¨)</span>
                    </label>
                    <small style="color: #666; margin-left: 30px; display: block; margin-top: 5px;">
                        ì˜ˆ: 00:00:15.23 (í˜„ì¬ ì¬ìƒ ì‹œê°„ í‘œì‹œ)
                    </small>
                </div>
            </div>

            <!-- ê°„ê²© ìº¡ì²˜ ì˜µì…˜ -->
            <div class="gif-controls" id="intervalCaptureControls" style="display: none;">
                <h3>ğŸ¬ ê°„ê²© ìº¡ì²˜ ì˜µì…˜</h3>
                <div class="gif-options">
                    <label>
                        ì‹œì‘ ì‹œê°„ (ì´ˆ)
                        <input type="number" id="intervalStartTime" value="0" min="0" step="0.1">
                        <small style="color: #666; margin-top: 5px;">ìº¡ì²˜ë¥¼ ì‹œì‘í•  ì‹œê°„</small>
                    </label>
                    <label>
                        ì¢…ë£Œ ì‹œê°„ (ì´ˆ)
                        <input type="number" id="intervalEndTime" value="10" min="0" step="0.1">
                        <small style="color: #666; margin-top: 5px;">ìº¡ì²˜ë¥¼ ì¢…ë£Œí•  ì‹œê°„ (0 = ë¹„ë””ì˜¤ ëê¹Œì§€)</small>
                    </label>
                    <label>
                        ê°„ê²© (ì´ˆ)
                        <select id="intervalSeconds">
                            <option value="0.5">0.5ì´ˆë§ˆë‹¤</option>
                            <option value="1" selected>1ì´ˆë§ˆë‹¤</option>
                            <option value="2">2ì´ˆë§ˆë‹¤</option>
                            <option value="3">3ì´ˆë§ˆë‹¤</option>
                            <option value="5">5ì´ˆë§ˆë‹¤</option>
                            <option value="10">10ì´ˆë§ˆë‹¤</option>
                            <option value="custom">ì§ì ‘ ì…ë ¥</option>
                        </select>
                        <input type="number" id="intervalCustomSeconds" value="1" min="0.1" step="0.1" style="margin-top: 10px; display: none;">
                    </label>
                    <label>
                        ì´ë¯¸ì§€ í¬ë§·
                        <select id="intervalFormat">
                            <option value="png">PNG (ë¬´ì†ì‹¤)</option>
                            <option value="jpg" selected>JPG (ì••ì¶•)</option>
                        </select>
                    </label>
                </div>
                <button class="btn btn-secondary" onclick="startIntervalCapture()" id="startIntervalBtn">
                    âœ¨ ê°„ê²© ìº¡ì²˜ ì‹œì‘
                </button>
                <button class="btn" onclick="stopIntervalCapture()" id="stopIntervalBtn" style="display: none; background: linear-gradient(135deg, #f44336 0%, #e91e63 100%);">
                    â¹ï¸ ì¤‘ì§€
                </button>
            </div>

            <!-- GIF ì˜µì…˜ -->
            <div class="gif-controls" id="gifControls" style="display: none;">
                <h3>GIF ìƒì„± ì˜µì…˜</h3>

                <!-- íƒ€ì„ë¼ì¸ ë²”ìœ„ ì„ íƒ (GIF) -->
                <div style="margin-bottom: 20px;">
                    <p style="color: #666; font-size: 14px; margin-bottom: 10px;">
                        ğŸ“Š GIF êµ¬ê°„ ì„ íƒ: <span id="gifRangeTimeDisplay">0:00 ~ 0:03</span> (ê¸¸ì´: <span id="gifRangeDurationDisplay">0:03</span>)
                    </p>
                    <div id="gifTimelineContainer" style="position: relative; height: 60px; background: #ddd; border-radius: 4px; cursor: pointer; overflow: hidden;">
                        <!-- ì„ íƒëœ ë²”ìœ„ í•˜ì´ë¼ì´íŠ¸ -->
                        <div id="gifSelectedRange" style="position: absolute; height: 100%; background: rgba(76, 175, 80, 0.3); border-left: 3px solid #4CAF50; border-right: 3px solid #4CAF50; pointer-events: none;"></div>

                        <!-- ì‹œì‘ í•¸ë“¤ -->
                        <div id="gifStartHandle" class="timeline-handle"
                             onmousedown="handleGifDragStart(event, 'start')"
                             ontouchstart="handleGifTouchStart(event, 'start')"
                             style="position: absolute; left: 0; top: 0; width: 40px; height: 100%; background: #4CAF50; cursor: ew-resize; display: flex; align-items: center; justify-content: center; color: white; font-size: 24px; user-select: none; z-index: 10; box-shadow: 0 2px 8px rgba(0,0,0,0.2); touch-action: none;">
                            â—€
                        </div>

                        <!-- ì¢…ë£Œ í•¸ë“¤ -->
                        <div id="gifEndHandle" class="timeline-handle"
                             onmousedown="handleGifDragStart(event, 'end')"
                             ontouchstart="handleGifTouchStart(event, 'end')"
                             style="position: absolute; left: 100%; top: 0; width: 40px; height: 100%; background: #4CAF50; cursor: ew-resize; display: flex; align-items: center; justify-content: center; color: white; font-size: 24px; user-select: none; z-index: 10; box-shadow: 0 2px 8px rgba(0,0,0,0.2); margin-left: -40px; touch-action: none;">
                            â–¶
                        </div>
                    </div>
                </div>

                <div class="gif-options">
                    <label>
                        í”„ë ˆì„ ë ˆì´íŠ¸ (fps)
                        <input type="number" id="gifFps" value="10" min="5" max="30" step="5">
                        <small style="color: #666;">ë‚®ì„ìˆ˜ë¡ ìš©ëŸ‰ ì‘ì•„ì§</small>
                    </label>
                    <label>
                        ë„ˆë¹„ (í”½ì…€)
                        <input type="number" id="gifWidth" value="480" min="240" max="1920" step="120">
                        <small style="color: #666;">ì‘ì„ìˆ˜ë¡ ìš©ëŸ‰ ì‘ì•„ì§</small>
                    </label>
                    <label>
                        í’ˆì§ˆ
                        <select id="gifQuality">
                            <option value="1">ìµœê³  (ìš©ëŸ‰ í¼, ëŠë¦¼)</option>
                            <option value="5">ë†’ìŒ</option>
                            <option value="10" selected>ë³´í†µ (ê¶Œì¥)</option>
                            <option value="15">ë‚®ìŒ (ìš©ëŸ‰ ì‘ìŒ)</option>
                            <option value="20">ìµœì†Œ (ìš©ëŸ‰ ë§¤ìš° ì‘ìŒ, ë¹ ë¦„)</option>
                        </select>
                        <small style="color: #666;">ë‚®ì„ìˆ˜ë¡ ìš©ëŸ‰ ì‘ì•„ì§€ê³  ë¹ ë¦„</small>
                    </label>
                </div>
                <button class="btn btn-secondary" onclick="generateGif()">
                    âœ¨ GIF ìƒì„± ì‹œì‘
                </button>
            </div>

            <!-- íŠ¸ë¦¼ ì˜µì…˜ -->
            <div class="gif-controls" id="trimControls" style="display: none;">
                <h3>âœ‚ï¸ êµ¬ê°„ ì˜ë¼ë‚´ê¸° ì˜µì…˜</h3>
                <p style="color: #666; font-size: 14px; margin-bottom: 15px;">
                    ì„ íƒí•œ êµ¬ê°„: <span id="trimRangeDisplay">0.0ì´ˆ ~ 10.0ì´ˆ</span> (ê¸¸ì´: <span id="trimDurationDisplay">10.0ì´ˆ</span>)
                </p>
                <div class="gif-options">
                    <label>
                        ì‹œì‘ ì‹œê°„
                        <input type="range" id="trimStartTime" value="0" min="0" step="0.1" oninput="updateTrimRange()">
                        <input type="number" id="trimStartTimeNum" value="0" min="0" step="0.1" style="margin-top: 10px;" oninput="updateTrimRangeFromNum()">
                        <small style="color: #666; margin-top: 5px;">ìŠ¬ë¼ì´ë” ë˜ëŠ” ìˆ«ìë¡œ ì¡°ì ˆ</small>
                    </label>
                    <label>
                        ì¢…ë£Œ ì‹œê°„
                        <input type="range" id="trimEndTime" value="10" min="0" step="0.1" oninput="updateTrimRange()">
                        <input type="number" id="trimEndTimeNum" value="10" min="0" step="0.1" style="margin-top: 10px;" oninput="updateTrimRangeFromNum()">
                        <small style="color: #666; margin-top: 5px;">ìŠ¬ë¼ì´ë” ë˜ëŠ” ìˆ«ìë¡œ ì¡°ì ˆ</small>
                    </label>
                    <label>
                        í”„ë ˆì„ ë ˆì´íŠ¸ (fps)
                        <select id="trimFps">
                            <option value="24">24 fps</option>
                            <option value="30" selected>30 fps</option>
                            <option value="60">60 fps</option>
                        </select>
                        <small style="color: #666; margin-top: 5px;">ë†’ì„ìˆ˜ë¡ ë¶€ë“œëŸ½ì§€ë§Œ íŒŒì¼ í¬ê¸° ì¦ê°€</small>
                    </label>
                    <label>
                        ë¹„ë””ì˜¤ í’ˆì§ˆ
                        <select id="trimQuality">
                            <option value="10000000">ìµœê³  (10 Mbps)</option>
                            <option value="8000000" selected>ê³ í’ˆì§ˆ (8 Mbps)</option>
                            <option value="5000000">ì¤‘ê°„ (5 Mbps)</option>
                            <option value="3000000">ë‚®ìŒ (3 Mbps)</option>
                        </select>
                    </label>
                </div>
                <button class="btn" onclick="startTrimVideo()">
                    âœ¨ êµ¬ê°„ ì˜ë¼ë‚´ê¸° ì‹œì‘
                </button>
            </div>

            <!-- ì¸ë„¤ì¼ ìƒì„± ì˜µì…˜ -->
            <div class="gif-controls" id="thumbnailControls" style="display: none;">
                <h3>ğŸ–¼ï¸ ì¸ë„¤ì¼ ìƒì„± ì˜µì…˜</h3>
                <div class="gif-options">
                    <label>
                        ì¸ë„¤ì¼ ê°œìˆ˜
                        <select id="thumbnailCount">
                            <option value="4">4ê°œ (2x2)</option>
                            <option value="6" selected>6ê°œ (3x2)</option>
                            <option value="9">9ê°œ (3x3)</option>
                            <option value="12">12ê°œ (4x3)</option>
                            <option value="16">16ê°œ (4x4)</option>
                        </select>
                    </label>
                    <label>
                        ì¸ë„¤ì¼ í¬ê¸°
                        <select id="thumbnailSize">
                            <option value="160">ì‘ê²Œ (160px)</option>
                            <option value="240" selected>ë³´í†µ (240px)</option>
                            <option value="320">í¬ê²Œ (320px)</option>
                            <option value="480">ë§¤ìš° í¬ê²Œ (480px)</option>
                        </select>
                    </label>
                    <label>
                        ì¶œë ¥ í˜•ì‹
                        <select id="thumbnailOutput">
                            <option value="grid" selected>ë‹¨ì¼ ê·¸ë¦¬ë“œ ì´ë¯¸ì§€</option>
                            <option value="individual">ê°œë³„ ì´ë¯¸ì§€</option>
                        </select>
                        <small style="color: #666; margin-top: 5px;">ê·¸ë¦¬ë“œ: í•˜ë‚˜ì˜ ì´ë¯¸ì§€ë¡œ ê²°í•© / ê°œë³„: ê°ê° ë³„ë„ ì €ì¥</small>
                    </label>
                    <label>
                        ì´ë¯¸ì§€ í¬ë§·
                        <select id="thumbnailFormat">
                            <option value="png">PNG (ë¬´ì†ì‹¤)</option>
                            <option value="jpg" selected>JPG (ì••ì¶•)</option>
                        </select>
                    </label>
                </div>
                <button class="btn btn-success" onclick="startGenerateThumbnails()">
                    âœ¨ ì¸ë„¤ì¼ ìƒì„± ì‹œì‘
                </button>
            </div>

            <!-- ìŠ¬ë¡œìš° ëª¨ì…˜ ì˜µì…˜ -->
            <div class="gif-controls" id="slowMotionControls" style="display: none;">
                <h3>â±ï¸ ìŠ¬ë¡œìš° ëª¨ì…˜ ì˜µì…˜</h3>
                <div class="gif-options">
                    <label>
                        ìŠ¬ë¡œìš° ëª¨ì…˜ ì†ë„
                        <select id="slowMotionSpeed" style="margin-top: 5px; padding: 8px; border: 2px solid #ddd; border-radius: 6px;">
                            <option value="0.1">0.1x (10% - ê·¹ë„ë¡œ ëŠë¦¼)</option>
                            <option value="0.2">0.2x (20% - ì•„ì£¼ ëŠë¦¼)</option>
                            <option value="0.25">0.25x (25% - ë§¤ìš° ëŠë¦¼)</option>
                            <option value="0.33">0.33x (33% - 3ë°° ëŠë¦¼)</option>
                            <option value="0.5" selected>0.5x (50% - 2ë°° ëŠë¦¼)</option>
                            <option value="0.67">0.67x (67% - 1.5ë°° ëŠë¦¼)</option>
                            <option value="0.75">0.75x (75% - ì•½ê°„ ëŠë¦¼)</option>
                            <option value="0.8">0.8x (80% - ì‚´ì§ ëŠë¦¼)</option>
                        </select>
                        <small style="color: #666; margin-top: 5px;">ì„ íƒí•œ êµ¬ê°„ë§Œ ìŠ¬ë¡œìš° ëª¨ì…˜ ì ìš©, ë‚˜ë¨¸ì§€ëŠ” ì •ìƒ ì†ë„</small>
                    </label>
                    <label>
                        í”„ë ˆì„ ë ˆì´íŠ¸ (fps)
                        <select id="slowMotionFps" style="margin-top: 5px; padding: 8px; border: 2px solid #ddd; border-radius: 6px;">
                            <option value="30">30 fps</option>
                            <option value="60" selected>60 fps (ê¶Œì¥)</option>
                        </select>
                    </label>
                    <label>
                        ë¹„ë””ì˜¤ í’ˆì§ˆ
                        <select id="slowMotionQuality" style="margin-top: 5px; padding: 8px; border: 2px solid #ddd; border-radius: 6px;">
                            <option value="10000000">ìµœê³  (10 Mbps)</option>
                            <option value="8000000" selected>ê³ í’ˆì§ˆ (8 Mbps)</option>
                            <option value="5000000">ì¤‘ê°„ (5 Mbps)</option>
                            <option value="3000000">ë‚®ìŒ (3 Mbps)</option>
                        </select>
                    </label>
                    <label>
                        ì¶œë ¥ í¬ë§·
                        <select id="slowMotionFormat" style="margin-top: 5px; padding: 8px; border: 2px solid #ddd; border-radius: 6px;">
                            <option value="mp4" selected>MP4 (ë²”ìš©, ëª¨ë“  í”Œë ˆì´ì–´ í˜¸í™˜)</option>
                            <option value="webm">WebM (ë¹ ë¦„, íŒŒì¼ ì‘ìŒ)</option>
                        </select>
                        <small style="color: #666; margin-top: 5px;">MP4ëŠ” ë³€í™˜ ì‹œê°„ ì¶”ê°€, WebMì€ ì¦‰ì‹œ ì €ì¥</small>
                    </label>
                </div>
                <button class="btn" onclick="startSlowMotionVideo()">
                    âœ¨ ìŠ¬ë¡œìš° ëª¨ì…˜ ìƒì„±
                </button>
            </div>

            <!-- ì—­ì¬ìƒ ì˜µì…˜ -->
            <div class="gif-controls" id="reverseControls" style="display: none;">
                <h3>ì—­ì¬ìƒ ìƒì„± ì˜µì…˜</h3>
                <div class="gif-options">
                    <label>
                        í”„ë ˆì„ ë ˆì´íŠ¸ (fps)
                        <input type="number" id="reverseFps" value="60" min="30" max="60" step="10">
                        <small style="color: #666; margin-top: 5px;">ë†’ì„ìˆ˜ë¡ ë¶€ë“œëŸ½ì§€ë§Œ ì²˜ë¦¬ ì‹œê°„ ì¦ê°€</small>
                    </label>
                    <label>
                        ë¹„ë””ì˜¤ í’ˆì§ˆ
                        <select id="reverseQuality" style="margin-top: 5px; padding: 8px; border: 2px solid #ddd; border-radius: 6px;">
                            <option value="10000000">ìµœê³  (10 Mbps)</option>
                            <option value="8000000" selected>ê³ í’ˆì§ˆ (8 Mbps)</option>
                            <option value="5000000">ì¤‘ê°„ (5 Mbps)</option>
                            <option value="3000000">ë‚®ìŒ (3 Mbps)</option>
                        </select>
                    </label>
                    <label>
                        ì¶œë ¥ í¬ë§·
                        <select id="reverseFormat" style="margin-top: 5px; padding: 8px; border: 2px solid #ddd; border-radius: 6px;">
                            <option value="mp4" selected>MP4 (ë²”ìš©, ëª¨ë“  í”Œë ˆì´ì–´ í˜¸í™˜)</option>
                            <option value="webm">WebM (ë¹ ë¦„, íŒŒì¼ ì‘ìŒ)</option>
                        </select>
                        <small style="color: #666; margin-top: 5px;">MP4ëŠ” ë³€í™˜ ì‹œê°„ ì¶”ê°€, WebMì€ ì¦‰ì‹œ ì €ì¥</small>
                    </label>
                </div>
                <button class="btn" onclick="startReverseVideo()">
                    âœ¨ ì—­ì¬ìƒ ì‹œì‘
                </button>
            </div>

            <!-- ê³ í™”ì§ˆ ë¹„ë””ì˜¤ ì˜µì…˜ -->
            <div class="gif-controls" id="highQualityControls" style="display: none;">
                <h3>âš¡ ê³ í™”ì§ˆ ë¹„ë””ì˜¤ ìƒì„± ì˜µì…˜</h3>
                <p style="color: #666; font-size: 14px; margin-bottom: 15px; padding: 10px; background: #f0f8ff; border-left: 4px solid #4CAF50; border-radius: 4px;">
                    ğŸ’¡ <strong>í”„ë ˆì„ ë³´ê°„ ê¸°ìˆ </strong>ë¡œ ë¶€ë“œëŸ¬ìš´ ê³ í™”ì§ˆ ì˜ìƒì„ ìƒì„±í•©ë‹ˆë‹¤. ì›ë³¸ í”„ë ˆì„ ì‚¬ì´ì— ì¤‘ê°„ í”„ë ˆì„ì„ ìë™ ìƒì„±í•˜ì—¬ ë” ìì—°ìŠ¤ëŸ¬ìš´ ì¬ìƒì„ ì œê³µí•©ë‹ˆë‹¤.
                </p>
                <div class="gif-options">
                    <label>
                        ëª©í‘œ FPS (í”„ë ˆì„ ë ˆì´íŠ¸)
                        <select id="highQualityTargetFps" style="margin-top: 5px; padding: 8px; border: 2px solid #ddd; border-radius: 6px;">
                            <option value="60" selected>60 fps (2ë°° ë¶€ë“œëŸ¬ì›€)</option>
                            <option value="90">90 fps (3ë°° ë¶€ë“œëŸ¬ì›€)</option>
                            <option value="120">120 fps (4ë°° ë¶€ë“œëŸ¬ì›€ - ìµœê³ )</option>
                        </select>
                        <small style="color: #666; margin-top: 5px; display: block;">ì›ë³¸ 30fps ê¸°ì¤€ í”„ë ˆì„ ë³´ê°„</small>
                    </label>
                    <label>
                        ë³´ê°„ í’ˆì§ˆ
                        <select id="highQualityInterpolation" style="margin-top: 5px; padding: 8px; border: 2px solid #ddd; border-radius: 6px;">
                            <option value="normal">ë³´í†µ (ë¹ ë¥¸ ì²˜ë¦¬)</option>
                            <option value="high" selected>ê³ í’ˆì§ˆ (ê¶Œì¥)</option>
                            <option value="ultra">ìµœê³ í’ˆì§ˆ (ëŠë¦° ì²˜ë¦¬)</option>
                        </select>
                        <small style="color: #666; margin-top: 5px; display: block;">í’ˆì§ˆì´ ë†’ì„ìˆ˜ë¡ ì²˜ë¦¬ ì‹œê°„ ì¦ê°€</small>
                    </label>
                    <label>
                        ë¹„ë””ì˜¤ í’ˆì§ˆ (ë¹„íŠ¸ë ˆì´íŠ¸)
                        <select id="highQualityBitrate" style="margin-top: 5px; padding: 8px; border: 2px solid #ddd; border-radius: 6px;">
                            <option value="15000000">ì´ˆê³ í™”ì§ˆ (15 Mbps)</option>
                            <option value="12000000" selected>ìµœê³  (12 Mbps)</option>
                            <option value="10000000">ê³ í’ˆì§ˆ (10 Mbps)</option>
                            <option value="8000000">ì¤‘ê°„ (8 Mbps)</option>
                        </select>
                    </label>
                    <label>
                        ì¶œë ¥ í¬ë§·
                        <select id="highQualityFormat" style="margin-top: 5px; padding: 8px; border: 2px solid #ddd; border-radius: 6px;">
                            <option value="mp4" selected>MP4 (ë²”ìš©, ëª¨ë“  í”Œë ˆì´ì–´ í˜¸í™˜)</option>
                            <option value="webm">WebM (ë¹ ë¦„, íŒŒì¼ ì‘ìŒ)</option>
                        </select>
                        <small style="color: #666; margin-top: 5px;">MP4ëŠ” ë³€í™˜ ì‹œê°„ ì¶”ê°€, WebMì€ ì¦‰ì‹œ ì €ì¥</small>
                    </label>
                    <label style="display: flex; align-items: center; gap: 10px; margin-top: 10px;">
                        <input type="checkbox" id="highQualityApplyFilter" checked style="width: auto;">
                        <span>í˜„ì¬ í•„í„° ì ìš©</span>
                    </label>
                </div>
                <button class="btn" onclick="startHighQualityVideo()" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); margin-top: 15px;">
                    âœ¨ ê³ í™”ì§ˆ ë¹„ë””ì˜¤ ìƒì„±
                </button>
            </div>

            <!-- ì§„í–‰ ìƒí™© -->
            <div class="progress-container" id="progressContainer">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill">0%</div>
                </div>
            </div>

            <!-- ìƒíƒœ ë©”ì‹œì§€ -->
            <div class="status" id="statusMessage"></div>
        </div>
    </div>

    <!-- GIF.js ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
    <script src="gif.js"></script>

    <!-- FFmpeg.wasm ë¼ì´ë¸ŒëŸ¬ë¦¬ (WebM â†’ MP4 ë³€í™˜) -->
    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.12.6/dist/umd/ffmpeg.js"></script>
    <script src="https://unpkg.com/@ffmpeg/util@0.12.1/dist/umd/index.js"></script>

    <script>
        const videoPlayer = document.getElementById('videoPlayer');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const previewCanvas = document.getElementById('previewCanvas');
        const previewCtx = previewCanvas.getContext('2d');
        const fileInput = document.getElementById('fileInput');
        const urlInput = document.getElementById('urlInput');

        let currentVideoFile = null;
        let saveFolderHandle = null; // ì„ íƒëœ ì €ì¥ í´ë” í•¸ë“¤
        let allowPlay = true; // ì¬ìƒ í—ˆìš© í”Œë˜ê·¸
        let previewAnimationId = null; // í”„ë¦¬ë·° ì• ë‹ˆë©”ì´ì…˜ ID

        // FFmpeg ì¸ìŠ¤í„´ìŠ¤
        let ffmpeg = null;
        let ffmpegLoaded = false;

        // ë¹„ë””ì˜¤ ê°¤ëŸ¬ë¦¬
        let videoFolderHandle = null; // ì„ íƒëœ ë¹„ë””ì˜¤ í´ë” í•¸ë“¤
        let videoFiles = []; // í´ë” ë‚´ ë¹„ë””ì˜¤ íŒŒì¼ ëª©ë¡
        let selectedVideoIndex = -1; // í˜„ì¬ ì„ íƒëœ ë¹„ë””ì˜¤ ì¸ë±ìŠ¤

        // í•„í„° ìƒíƒœ
        let filterState = {
            brightness: 100,
            contrast: 100,
            saturation: 100,
            hue: 0,
            blur: 0,
            grayscale: 0
        };

        // íŒŒì¼ ì…ë ¥ ì²˜ë¦¬
        fileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                currentVideoFile = file;
                const url = URL.createObjectURL(file);
                videoPlayer.src = url;
                enableControls();
                showStatus('ë¹„ë””ì˜¤ê°€ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            }
        });

        // URLì—ì„œ ë¹„ë””ì˜¤ ë¡œë“œ
        function loadVideoFromURL() {
            const url = urlInput.value.trim();
            if (!url) {
                showStatus('URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            videoPlayer.src = url;
            currentVideoFile = null; // URL ëª¨ë“œ
            enableControls();
            showStatus('URLì—ì„œ ë¹„ë””ì˜¤ë¥¼ ë¡œë“œí–ˆìŠµë‹ˆë‹¤.', 'success');
        }

        // í•„í„° í† ê¸€
        function toggleFilters() {
            const filterControls = document.getElementById('filterControls');
            const toggleBtn = document.getElementById('filterToggleBtn');

            if (filterControls.style.display === 'none') {
                filterControls.style.display = 'block';
                toggleBtn.innerHTML = 'ğŸ¨ í•„í„° ì¡°ì ˆ â–²';
            } else {
                filterControls.style.display = 'none';
                toggleBtn.innerHTML = 'ğŸ¨ í•„í„° ì¡°ì ˆ â–¼';
            }
        }

        // í…ìŠ¤íŠ¸ ì˜µì…˜ í† ê¸€
        function toggleTextOptions() {
            const textControls = document.getElementById('textControls');
            const toggleBtn = document.getElementById('textToggleBtn');

            if (textControls.style.display === 'none') {
                textControls.style.display = 'block';
                toggleBtn.innerHTML = 'âœï¸ í…ìŠ¤íŠ¸ ì¶”ê°€ â–²';
            } else {
                textControls.style.display = 'none';
                toggleBtn.innerHTML = 'âœï¸ í…ìŠ¤íŠ¸ ì¶”ê°€ â–¼';
            }
        }

        // ì»¨íŠ¸ë¡¤ ë²„íŠ¼ í™œì„±í™”
        function enableControls() {
            document.getElementById('capturePngBtn').disabled = false;
            document.getElementById('captureJpgBtn').disabled = false;
            document.getElementById('intervalCaptureBtn').disabled = false;
            document.getElementById('gifBtn').disabled = false;
            document.getElementById('trimBtn').disabled = false;
            document.getElementById('thumbnailBtn').disabled = false;
            document.getElementById('slowMotionBtn').disabled = false;
            document.getElementById('reverseBtn').disabled = false;
            document.getElementById('highQualityBtn').disabled = false;
            document.getElementById('filterToggleBtn').disabled = false;
            document.getElementById('textToggleBtn').disabled = false;
            document.getElementById('powerSlowToggleBtn').disabled = false;
        }

        // ì¬ìƒ ì†ë„ ë³€ê²½
        function changePlaybackSpeed() {
            const speed = parseFloat(document.getElementById('playbackSpeed').value);
            videoPlayer.playbackRate = speed;
            showStatus(`ì¬ìƒ ì†ë„ë¥¼ ${speed}xë¡œ ë³€ê²½í–ˆìŠµë‹ˆë‹¤.`, 'success');
        }

        // ì €ì¥ í´ë” ì„ íƒ
        async function selectSaveFolder() {
            try {
                // File System Access API ì§€ì› í™•ì¸
                if (!('showDirectoryPicker' in window)) {
                    showStatus('ì´ ë¸Œë¼ìš°ì €ëŠ” í´ë” ì„ íƒì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. Chrome/Edgeë¥¼ ì‚¬ìš©í•´ì£¼ì„¸ìš”.', 'error');
                    return;
                }

                // í´ë” ì„ íƒ ëŒ€í™”ìƒì í‘œì‹œ
                saveFolderHandle = await window.showDirectoryPicker({
                    mode: 'readwrite'
                });

                // UI ì—…ë°ì´íŠ¸
                const folderSelector = document.getElementById('folderSelector');
                const folderPath = document.getElementById('folderPath');

                folderPath.textContent = saveFolderHandle.name;
                folderSelector.classList.add('active');

                showStatus(`ì €ì¥ í´ë”: ${saveFolderHandle.name}`, 'success');
            } catch (err) {
                if (err.name !== 'AbortError') {
                    console.error('í´ë” ì„ íƒ ì˜¤ë¥˜:', err);
                    showStatus('í´ë” ì„ íƒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                }
            }
        }

        // ===============================
        // FFmpeg.wasm ì´ˆê¸°í™” ë° ë³€í™˜
        // ===============================

        // FFmpeg ì´ˆê¸°í™” (lazy loading)
        async function loadFFmpeg() {
            if (ffmpegLoaded) return true;

            try {
                showStatus('FFmpeg ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë”© ì¤‘...', 'info');

                const { FFmpeg } = FFmpegWASM;
                const { fetchFile } = FFmpegUtil;

                ffmpeg = new FFmpeg();

                await ffmpeg.load({
                    coreURL: 'https://unpkg.com/@ffmpeg/core@0.12.4/dist/umd/ffmpeg-core.js',
                    wasmURL: 'https://unpkg.com/@ffmpeg/core@0.12.4/dist/umd/ffmpeg-core.wasm'
                });

                ffmpegLoaded = true;
                showStatus('FFmpeg ë¡œë”© ì™„ë£Œ!', 'success');
                return true;
            } catch (error) {
                console.error('FFmpeg ë¡œë”© ì˜¤ë¥˜:', error);
                showStatus('FFmpeg ë¡œë”© ì‹¤íŒ¨. WebM í¬ë§·ë§Œ ì‚¬ìš©ë©ë‹ˆë‹¤.', 'warning');
                return false;
            }
        }

        // WebMì„ MP4ë¡œ ë³€í™˜
        async function convertWebMToMP4(webmBlob, filename) {
            try {
                showStatus('MP4ë¡œ ë³€í™˜ ì¤‘... ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.', 'info');
                showProgress(50);

                const { fetchFile } = FFmpegUtil;

                // FFmpeg íŒŒì¼ ì‹œìŠ¤í…œì— WebM ì“°ê¸°
                const inputName = 'input.webm';
                const outputName = 'output.mp4';

                await ffmpeg.writeFile(inputName, await fetchFile(webmBlob));

                // WebM â†’ MP4 ë³€í™˜
                await ffmpeg.exec([
                    '-i', inputName,
                    '-c:v', 'libx264',      // H.264 ë¹„ë””ì˜¤ ì½”ë±
                    '-preset', 'medium',     // ì¸ì½”ë”© ì†ë„/í’ˆì§ˆ ê· í˜•
                    '-crf', '23',            // í’ˆì§ˆ (ë‚®ì„ìˆ˜ë¡ ê³ í’ˆì§ˆ, 18-28 ê¶Œì¥)
                    '-c:a', 'aac',           // AAC ì˜¤ë””ì˜¤ ì½”ë±
                    '-b:a', '128k',          // ì˜¤ë””ì˜¤ ë¹„íŠ¸ë ˆì´íŠ¸
                    '-movflags', '+faststart', // ìŠ¤íŠ¸ë¦¬ë° ìµœì í™”
                    outputName
                ]);

                // MP4 íŒŒì¼ ì½ê¸°
                const data = await ffmpeg.readFile(outputName);
                const mp4Blob = new Blob([data.buffer], { type: 'video/mp4' });

                // ì„ì‹œ íŒŒì¼ ì •ë¦¬
                await ffmpeg.deleteFile(inputName);
                await ffmpeg.deleteFile(outputName);

                showProgress(100);
                showStatus('MP4 ë³€í™˜ ì™„ë£Œ!', 'success');

                return mp4Blob;
            } catch (error) {
                console.error('MP4 ë³€í™˜ ì˜¤ë¥˜:', error);
                showStatus('MP4 ë³€í™˜ ì‹¤íŒ¨. WebM íŒŒì¼ì„ ì €ì¥í•©ë‹ˆë‹¤.', 'warning');
                return null;
            }
        }

        // íŒŒì¼ì„ ì„ íƒëœ í´ë” ë˜ëŠ” ë‹¤ìš´ë¡œë“œë¡œ ì €ì¥
        async function saveFile(blob, filename) {
            const fileSizeKB = (blob.size / 1024).toFixed(1);
            const fileSizeMB = (blob.size / 1024 / 1024).toFixed(2);
            const sizeText = blob.size > 1024 * 1024 ? `${fileSizeMB}MB` : `${fileSizeKB}KB`;

            if (saveFolderHandle) {
                try {
                    // ì„ íƒëœ í´ë”ì— ì €ì¥
                    const fileHandle = await saveFolderHandle.getFileHandle(filename, { create: true });
                    const writable = await fileHandle.createWritable();
                    await writable.write(blob);
                    await writable.close();

                    // ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ
                    const message = `âœ… ì €ì¥ ì™„ë£Œ!\níŒŒì¼: ${filename}\ní¬ê¸°: ${sizeText}\nìœ„ì¹˜: ${saveFolderHandle.name} í´ë”`;
                    showStatus(message, 'success');
                    showSaveNotification(filename, sizeText, `${saveFolderHandle.name} í´ë”`);
                } catch (err) {
                    console.error('íŒŒì¼ ì €ì¥ ì˜¤ë¥˜:', err);
                    // ì‹¤íŒ¨ ì‹œ ê¸°ë³¸ ë‹¤ìš´ë¡œë“œë¡œ ì „í™˜
                    downloadFile(blob, filename);
                }
            } else {
                // í´ë”ê°€ ì„ íƒë˜ì§€ ì•Šì•˜ìœ¼ë©´ ê¸°ë³¸ ë‹¤ìš´ë¡œë“œ
                downloadFile(blob, filename);
            }
        }

        // ë¸Œë¼ìš°ì € ë‹¤ìš´ë¡œë“œë¡œ ì €ì¥ (ê¸°ë³¸ ë°©ì‹)
        function downloadFile(blob, filename) {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);

            // íŒŒì¼ í¬ê¸° ê³„ì‚°
            const fileSizeKB = (blob.size / 1024).toFixed(1);
            const fileSizeMB = (blob.size / 1024 / 1024).toFixed(2);
            const sizeText = blob.size > 1024 * 1024 ? `${fileSizeMB}MB` : `${fileSizeKB}KB`;

            // ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ
            const message = `âœ… ë‹¤ìš´ë¡œë“œ ì™„ë£Œ!\níŒŒì¼: ${filename}\ní¬ê¸°: ${sizeText}\nìœ„ì¹˜: ë‹¤ìš´ë¡œë“œ í´ë”`;
            showStatus(message, 'success');
            showSaveNotification(filename, sizeText, 'ë‹¤ìš´ë¡œë“œ í´ë”');
        }

        // ì €ì¥ ì™„ë£Œ ì•Œë¦¼ (í° íŒì—…)
        function showSaveNotification(filename, fileSize, location) {
            // ê¸°ì¡´ ì•Œë¦¼ ì œê±°
            const existing = document.getElementById('saveNotification');
            if (existing) {
                existing.remove();
            }

            // ì•Œë¦¼ ìƒì„±
            const notification = document.createElement('div');
            notification.id = 'saveNotification';
            notification.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 30px 40px;
                border-radius: 15px;
                box-shadow: 0 10px 40px rgba(0,0,0,0.3);
                z-index: 10000;
                text-align: center;
                min-width: 400px;
                animation: slideIn 0.3s ease-out;
            `;

            notification.innerHTML = `
                <div style="font-size: 48px; margin-bottom: 15px;">âœ…</div>
                <div style="font-size: 24px; font-weight: bold; margin-bottom: 10px;">ì €ì¥ ì™„ë£Œ!</div>
                <div style="font-size: 16px; opacity: 0.9; margin-bottom: 5px;">ğŸ“„ ${filename}</div>
                <div style="font-size: 14px; opacity: 0.8; margin-bottom: 5px;">ğŸ“¦ í¬ê¸°: ${fileSize}</div>
                <div style="font-size: 14px; opacity: 0.8;">ğŸ“ ìœ„ì¹˜: ${location}</div>
            `;

            document.body.appendChild(notification);

            // 3ì´ˆ í›„ ìë™ ì œê±°
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease-in';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // í˜„ì¬ í”„ë ˆì„ ìº¡ì²˜
        function captureFrame(format) {
            // ê³ í’ˆì§ˆ ìº¡ì²˜ë¥¼ ìœ„í•œ 2ë°° ìŠ¤ì¼€ì¼ ì‚¬ìš©
            const scale = 2;
            const width = videoPlayer.videoWidth;
            const height = videoPlayer.videoHeight;

            canvas.width = width * scale;
            canvas.height = height * scale;

            // ê³ í’ˆì§ˆ ë Œë”ë§ ì„¤ì •
            ctx.imageSmoothingEnabled = true;
            ctx.imageSmoothingQuality = 'high';

            // í•„í„° ì ìš©
            ctx.filter = getCurrentFilterString();

            // ìŠ¤ì¼€ì¼ ì ìš©í•˜ì—¬ ê·¸ë¦¬ê¸°
            ctx.drawImage(videoPlayer, 0, 0, canvas.width, canvas.height);

            // í•„í„° ì´ˆê¸°í™” (í…ìŠ¤íŠ¸ì—ëŠ” í•„í„° ë¯¸ì ìš©)
            ctx.filter = 'none';

            // í…ìŠ¤íŠ¸ ì¶”ê°€ (ì…ë ¥ëœ ê²½ìš°)
            const captureText = document.getElementById('captureText').value.trim();
            if (captureText) {
                const fontSize = parseInt(document.getElementById('captureFontSize').value) * scale;
                const textColor = document.getElementById('captureTextColor').value;
                const textPosition = document.getElementById('captureTextPosition').value;
                const textStyle = document.getElementById('captureTextStyle').value;

                // í°íŠ¸ ì„¤ì •
                ctx.font = `bold ${fontSize}px Arial, sans-serif`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';

                // í…ìŠ¤íŠ¸ ìœ„ì¹˜ ê³„ì‚°
                const x = canvas.width / 2;
                let y;
                const padding = fontSize * 0.8;

                if (textPosition === 'top') {
                    y = padding;
                } else if (textPosition === 'middle') {
                    y = canvas.height / 2;
                } else { // bottom
                    y = canvas.height - padding;
                }

                const textMetrics = ctx.measureText(captureText);
                const textWidth = textMetrics.width;
                const textHeight = fontSize * 1.4;

                // í…ìŠ¤íŠ¸ ë°°ê²½ (ìŠ¤íƒ€ì¼ì— ë”°ë¼)
                if (textStyle === 'background') {
                    // ë°˜íˆ¬ëª… ê²€ì • ë°•ìŠ¤
                    ctx.fillStyle = 'rgba(0, 0, 0, 0.6)';
                    ctx.fillRect(
                        x - textWidth / 2 - fontSize * 0.5,
                        y - textHeight / 2,
                        textWidth + fontSize,
                        textHeight
                    );
                }

                // í…ìŠ¤íŠ¸ ì™¸ê³½ì„  (ê°€ë…ì„± - íˆ¬ëª… ìŠ¤íƒ€ì¼ì—ì„œ ë” ë‘ê»ê²Œ)
                ctx.strokeStyle = '#000000';
                ctx.lineWidth = textStyle === 'transparent' ? scale * 4 : scale * 3;
                ctx.strokeText(captureText, x, y);

                // í…ìŠ¤íŠ¸ ë³¸ì²´
                ctx.fillStyle = textColor;
                ctx.fillText(captureText, x, y);
            }

            // íƒ€ì„ìŠ¤íƒ¬í”„ ìë™ í‘œì‹œ
            const showTimestamp = document.getElementById('showTimestamp').checked;
            if (showTimestamp) {
                // ì‹œê°„ í¬ë§·íŒ… í•¨ìˆ˜ (HH:MM:SS.ms)
                const formatTime = (seconds) => {
                    const hours = Math.floor(seconds / 3600);
                    const minutes = Math.floor((seconds % 3600) / 60);
                    const secs = Math.floor(seconds % 60);
                    const ms = Math.floor((seconds % 1) * 100);

                    return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(secs).padStart(2, '0')}.${String(ms).padStart(2, '0')}`;
                };

                const timestamp = formatTime(videoPlayer.currentTime);
                const timestampFontSize = 28 * scale; // ê³ ì • í¬ê¸°

                // í°íŠ¸ ì„¤ì •
                ctx.font = `bold ${timestampFontSize}px 'Courier New', monospace`;
                ctx.textAlign = 'right';
                ctx.textBaseline = 'bottom';

                // ìš°ì¸¡ í•˜ë‹¨ ìœ„ì¹˜
                const tsX = canvas.width - timestampFontSize * 0.5;
                const tsY = canvas.height - timestampFontSize * 0.5;

                // í…ìŠ¤íŠ¸ í¬ê¸° ì¸¡ì •
                const tsMetrics = ctx.measureText(timestamp);
                const tsWidth = tsMetrics.width;
                const tsHeight = timestampFontSize * 1.2;

                // ë°°ê²½ ë°•ìŠ¤
                ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
                ctx.fillRect(
                    tsX - tsWidth - timestampFontSize * 0.3,
                    tsY - tsHeight + timestampFontSize * 0.2,
                    tsWidth + timestampFontSize * 0.6,
                    tsHeight
                );

                // í…ìŠ¤íŠ¸ ì™¸ê³½ì„ 
                ctx.strokeStyle = '#000000';
                ctx.lineWidth = scale * 2;
                ctx.strokeText(timestamp, tsX, tsY);

                // í…ìŠ¤íŠ¸ ë³¸ì²´
                ctx.fillStyle = '#FFFFFF';
                ctx.fillText(timestamp, tsX, tsY);
            }

            const mimeType = format === 'png' ? 'image/png' : 'image/jpeg';
            const extension = format === 'png' ? 'png' : 'jpg';

            canvas.toBlob(async function(blob) {
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
                const filename = `capture_${timestamp}.${extension}`;
                await saveFile(blob, filename);
            }, mimeType, format === 'jpg' ? 1.0 : undefined);  // JPG ìµœëŒ€ í’ˆì§ˆ
        }

        // ê°„ê²© ìº¡ì²˜ ì˜µì…˜ í‘œì‹œ
        function showIntervalCaptureOptions() {
            const intervalControls = document.getElementById('intervalCaptureControls');
            const gifControls = document.getElementById('gifControls');
            const trimControls = document.getElementById('trimControls');
            const thumbnailControls = document.getElementById('thumbnailControls');
            const slowMotionControls = document.getElementById('slowMotionControls');
            const reverseControls = document.getElementById('reverseControls');
            const highQualityControls = document.getElementById('highQualityControls');

            gifControls.style.display = 'none';
            trimControls.style.display = 'none';
            thumbnailControls.style.display = 'none';
            slowMotionControls.style.display = 'none';
            reverseControls.style.display = 'none';
            highQualityControls.style.display = 'none';
            intervalControls.style.display = intervalControls.style.display === 'none' ? 'block' : 'none';

            if (intervalControls.style.display === 'block') {
                const duration = videoPlayer.duration || 0;
                document.getElementById('intervalStartTime').max = duration;
                document.getElementById('intervalEndTime').max = duration;
                document.getElementById('intervalEndTime').value = duration;
            }
        }

        // GIF ì˜µì…˜ í‘œì‹œ
        // GIF íƒ€ì´ë° ìœ íš¨ì„± ê²€ì‚¬ ë° ìë™ ì¡°ì •
        function validateGifTiming() {
            if (!videoPlayer.duration) return;

            const startTimeInput = document.getElementById('gifStartTime');
            const durationInput = document.getElementById('gifDuration');

            let startTime = parseFloat(startTimeInput.value) || 0;
            let duration = parseFloat(durationInput.value) || 0.5;

            // ì‹œì‘ ì‹œê°„ì´ ë¹„ë””ì˜¤ ê¸¸ì´ë¥¼ ì´ˆê³¼í•˜ë©´ ì¡°ì •
            if (startTime > videoPlayer.duration) {
                startTime = Math.max(0, videoPlayer.duration - 1);
                startTimeInput.value = startTime.toFixed(1);
            }

            // ì‹œì‘ ì‹œê°„ + ì§€ì† ì‹œê°„ì´ ë¹„ë””ì˜¤ ê¸¸ì´ë¥¼ ì´ˆê³¼í•˜ë©´ ì§€ì† ì‹œê°„ ìë™ ì¡°ì •
            if (startTime + duration > videoPlayer.duration) {
                const maxDuration = Math.max(0.5, videoPlayer.duration - startTime);
                durationInput.value = maxDuration.toFixed(1);
            }
        }

        function showGifOptions() {
            const intervalControls = document.getElementById('intervalCaptureControls');
            const gifControls = document.getElementById('gifControls');
            const trimControls = document.getElementById('trimControls');
            const thumbnailControls = document.getElementById('thumbnailControls');
            const slowMotionControls = document.getElementById('slowMotionControls');
            const reverseControls = document.getElementById('reverseControls');
            const highQualityControls = document.getElementById('highQualityControls');

            intervalControls.style.display = 'none';
            trimControls.style.display = 'none';
            thumbnailControls.style.display = 'none';
            slowMotionControls.style.display = 'none';
            reverseControls.style.display = 'none';
            highQualityControls.style.display = 'none';
            gifControls.style.display = gifControls.style.display === 'none' ? 'block' : 'none';

            if (gifControls.style.display === 'block') {
                // GIF íƒ€ì„ë¼ì¸ ì´ˆê¸°í™”
                initializeGifTimeline();
            }
        }

        // íŠ¸ë¦¼ êµ¬ê°„ í‘œì‹œ ì—…ë°ì´íŠ¸
        function updateTrimRange() {
            const startTime = parseFloat(document.getElementById('trimStartTime').value);
            const endTime = parseFloat(document.getElementById('trimEndTime').value);

            // ìˆ«ì ì…ë ¥ í•„ë“œ ë™ê¸°í™”
            document.getElementById('trimStartTimeNum').value = startTime.toFixed(1);
            document.getElementById('trimEndTimeNum').value = endTime.toFixed(1);

            // ì‹œì‘ ì‹œê°„ì´ ì¢…ë£Œ ì‹œê°„ë³´ë‹¤ í¬ë©´ ìë™ ì¡°ì •
            if (startTime >= endTime) {
                const newEnd = Math.min(startTime + 1, videoPlayer.duration);
                document.getElementById('trimEndTime').value = newEnd;
                document.getElementById('trimEndTimeNum').value = newEnd.toFixed(1);
            }

            updateTrimDisplay();
        }

        // ìˆ«ì ì…ë ¥ì—ì„œ ìŠ¬ë¼ì´ë” ì—…ë°ì´íŠ¸
        function updateTrimRangeFromNum() {
            const startTime = parseFloat(document.getElementById('trimStartTimeNum').value);
            const endTime = parseFloat(document.getElementById('trimEndTimeNum').value);

            document.getElementById('trimStartTime').value = startTime;
            document.getElementById('trimEndTime').value = endTime;

            updateTrimDisplay();
        }

        // ì„ íƒ êµ¬ê°„ í‘œì‹œ
        function updateTrimDisplay() {
            const startTime = parseFloat(document.getElementById('trimStartTime').value);
            const endTime = parseFloat(document.getElementById('trimEndTime').value);
            const duration = endTime - startTime;

            document.getElementById('trimRangeDisplay').textContent =
                `${startTime.toFixed(1)}ì´ˆ ~ ${endTime.toFixed(1)}ì´ˆ`;
            document.getElementById('trimDurationDisplay').textContent =
                `${duration.toFixed(1)}ì´ˆ`;
        }

        // í†µí•© íƒ€ì„ë¼ì¸ ë²”ìœ„ ì„ íƒ ìƒíƒœ (êµ¬ê°„ ì˜ë¼ë‚´ê¸°)
        let trimRangeState = {
            startTime: 0,
            endTime: 10,
            isDragging: false,
            dragTarget: null,
            containerWidth: 0,
            dragListenersInitialized: false
        };

        // GIF íƒ€ì„ë¼ì¸ ë²”ìœ„ ì„ íƒ ìƒíƒœ
        let gifRangeState = {
            startTime: 0,
            endTime: 3,
            isDragging: false,
            dragTarget: null,
            containerWidth: 0,
            dragListenersInitialized: false
        };

        // íŠ¸ë¦¼ ì˜µì…˜ í‘œì‹œ (í†µí•© íƒ€ì„ë¼ì¸)
        function showTrimOptions() {
            const timelineSelector = document.getElementById('timelineRangeSelector');
            const intervalControls = document.getElementById('intervalCaptureControls');
            const gifControls = document.getElementById('gifControls');
            const trimControls = document.getElementById('trimControls');
            const thumbnailControls = document.getElementById('thumbnailControls');
            const slowMotionControls = document.getElementById('slowMotionControls');
            const reverseControls = document.getElementById('reverseControls');
            const highQualityControls = document.getElementById('highQualityControls');

            // ëª¨ë“  ë‹¤ë¥¸ ì˜µì…˜ ìˆ¨ê¸°ê¸°
            intervalControls.style.display = 'none';
            gifControls.style.display = 'none';
            trimControls.style.display = 'none';
            thumbnailControls.style.display = 'none';
            slowMotionControls.style.display = 'none';
            reverseControls.style.display = 'none';
            highQualityControls.style.display = 'none';

            // í†µí•© íƒ€ì„ë¼ì¸ í† ê¸€
            if (timelineSelector.style.display === 'none') {
                timelineSelector.style.display = 'block';
                initializeTimeline();
            } else {
                timelineSelector.style.display = 'none';
            }
        }

        // íƒ€ì„ë¼ì¸ ì´ˆê¸°í™”
        function initializeTimeline() {
            const duration = videoPlayer.duration || 10;
            trimRangeState.startTime = 0;
            trimRangeState.endTime = Math.min(10, duration);

            // íƒ€ì„ë¼ì¸ ì»¨í…Œì´ë„ˆì˜ ë„ˆë¹„ë¥¼ ë¹„ë””ì˜¤ í”Œë ˆì´ì–´ì™€ ë™ì¼í•˜ê²Œ ì„¤ì •
            const timelineContainer = document.getElementById('timelineContainer');
            const videoWidth = videoPlayer.offsetWidth;
            timelineContainer.style.width = `${videoWidth}px`;
            trimRangeState.containerWidth = videoWidth;

            updateTimelineDisplay();

            // ë“œë˜ê·¸ ë¦¬ìŠ¤ë„ˆëŠ” í•œ ë²ˆë§Œ ì´ˆê¸°í™”
            if (!trimRangeState.dragListenersInitialized) {
                setupTimelineDrag();
                trimRangeState.dragListenersInitialized = true;
            }
        }

        // íƒ€ì„ë¼ì¸ ë‹«ê¸°
        function closeTrimMode() {
            document.getElementById('timelineRangeSelector').style.display = 'none';
        }

        // íƒ€ì„ë¼ì¸ í‘œì‹œ ì—…ë°ì´íŠ¸
        function updateTimelineDisplay() {
            const duration = videoPlayer.duration || 10;
            const containerWidth = trimRangeState.containerWidth;

            const startPercent = (trimRangeState.startTime / duration) * 100;
            const endPercent = (trimRangeState.endTime / duration) * 100;

            // í•¸ë“¤ ìœ„ì¹˜ ì—…ë°ì´íŠ¸
            const startHandle = document.getElementById('startHandle');
            const endHandle = document.getElementById('endHandle');
            const selectedRange = document.getElementById('selectedRange');

            startHandle.style.left = startPercent + '%';
            endHandle.style.left = endPercent + '%';

            selectedRange.style.left = startPercent + '%';
            selectedRange.style.width = (endPercent - startPercent) + '%';

            // ì‹œê°„ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
            const formatTime = (seconds) => {
                const mins = Math.floor(seconds / 60);
                const secs = Math.floor(seconds % 60);
                return `${mins}:${String(secs).padStart(2, '0')}`;
            };

            document.getElementById('rangeTimeDisplay').textContent =
                `${formatTime(trimRangeState.startTime)} ~ ${formatTime(trimRangeState.endTime)}`;
            document.getElementById('rangeDurationDisplay').textContent =
                formatTime(trimRangeState.endTime - trimRangeState.startTime);
        }

        // ì „ì—­ ë“œë˜ê·¸ ì‹œì‘ í•¨ìˆ˜ (HTMLì—ì„œ ì§ì ‘ í˜¸ì¶œ)
        function handleDragStart(e, target) {
            e.preventDefault();
            trimRangeState.isDragging = true;
            trimRangeState.dragTarget = target;
        }

        // í„°ì¹˜ ì´ë²¤íŠ¸ë„ ê°™ì€ í•¨ìˆ˜ ì‚¬ìš©
        function handleTouchStart(e, target) {
            handleDragStart(e, target);
        }

        // ë“œë˜ê·¸ ê¸°ëŠ¥ ì„¤ì •
        function setupTimelineDrag() {

            // ë§ˆìš°ìŠ¤ ì´ë™
            let mouseMoveHandler = (e) => {
                if (!trimRangeState.isDragging) return;

                const container = document.getElementById('timelineContainer');
                const rect = container.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const percent = Math.max(0, Math.min(1, x / rect.width));
                const duration = videoPlayer.duration || 10;
                const newTime = percent * duration;

                if (trimRangeState.dragTarget === 'start') {
                    trimRangeState.startTime = Math.min(newTime, trimRangeState.endTime - 0.5);
                    videoPlayer.currentTime = trimRangeState.startTime;
                } else if (trimRangeState.dragTarget === 'end') {
                    trimRangeState.endTime = Math.max(newTime, trimRangeState.startTime + 0.5);
                    videoPlayer.currentTime = trimRangeState.endTime;
                }

                updateTimelineDisplay();
            };

            document.addEventListener('mousemove', mouseMoveHandler);

            // í„°ì¹˜ ì´ë™ í•¸ë“¤ëŸ¬
            let touchMoveHandler = (e) => {
                if (!trimRangeState.isDragging) return;
                e.preventDefault();

                const touch = e.touches[0];
                const container = document.getElementById('timelineContainer');
                const rect = container.getBoundingClientRect();
                const x = touch.clientX - rect.left;
                const percent = Math.max(0, Math.min(1, x / rect.width));
                const duration = videoPlayer.duration || 10;
                const newTime = percent * duration;

                if (trimRangeState.dragTarget === 'start') {
                    trimRangeState.startTime = Math.min(newTime, trimRangeState.endTime - 0.5);
                    videoPlayer.currentTime = trimRangeState.startTime;
                } else if (trimRangeState.dragTarget === 'end') {
                    trimRangeState.endTime = Math.max(newTime, trimRangeState.startTime + 0.5);
                    videoPlayer.currentTime = trimRangeState.endTime;
                }

                updateTimelineDisplay();
            };

            document.addEventListener('touchmove', touchMoveHandler, { passive: false });

            // ë§ˆìš°ìŠ¤ ì—…
            let mouseUpHandler = () => {
                trimRangeState.isDragging = false;
                trimRangeState.dragTarget = null;
            };

            document.addEventListener('mouseup', mouseUpHandler);

            // í„°ì¹˜ ì¢…ë£Œ
            let touchEndHandler = () => {
                trimRangeState.isDragging = false;
                trimRangeState.dragTarget = null;
            };

            document.addEventListener('touchend', touchEndHandler);
            document.addEventListener('touchcancel', touchEndHandler);
        }

        // ===== GIF íƒ€ì„ë¼ì¸ ë“œë˜ê·¸ ê¸°ëŠ¥ =====

        // GIF ë“œë˜ê·¸ ì‹œì‘ í•¨ìˆ˜
        function handleGifDragStart(e, target) {
            e.preventDefault();
            gifRangeState.isDragging = true;
            gifRangeState.dragTarget = target;
        }

        // GIF í„°ì¹˜ ì‹œì‘ í•¨ìˆ˜
        function handleGifTouchStart(e, target) {
            handleGifDragStart(e, target);
        }

        // GIF íƒ€ì„ë¼ì¸ ì´ˆê¸°í™”
        function initializeGifTimeline() {
            const duration = videoPlayer.duration || 10;
            gifRangeState.startTime = 0;
            gifRangeState.endTime = Math.min(3, duration);

            // íƒ€ì„ë¼ì¸ ì»¨í…Œì´ë„ˆì˜ ë„ˆë¹„ë¥¼ ë¹„ë””ì˜¤ í”Œë ˆì´ì–´ì™€ ë™ì¼í•˜ê²Œ ì„¤ì •
            const timelineContainer = document.getElementById('gifTimelineContainer');
            const videoWidth = videoPlayer.offsetWidth;
            timelineContainer.style.width = `${videoWidth}px`;
            gifRangeState.containerWidth = videoWidth;

            updateGifTimelineDisplay();

            // ë“œë˜ê·¸ ë¦¬ìŠ¤ë„ˆëŠ” í•œ ë²ˆë§Œ ì´ˆê¸°í™”
            if (!gifRangeState.dragListenersInitialized) {
                setupGifTimelineDrag();
                gifRangeState.dragListenersInitialized = true;
            }
        }

        // GIF íƒ€ì„ë¼ì¸ í‘œì‹œ ì—…ë°ì´íŠ¸
        function updateGifTimelineDisplay() {
            const duration = videoPlayer.duration || 10;

            const startPercent = (gifRangeState.startTime / duration) * 100;
            const endPercent = (gifRangeState.endTime / duration) * 100;

            // í•¸ë“¤ ìœ„ì¹˜ ì—…ë°ì´íŠ¸
            const startHandle = document.getElementById('gifStartHandle');
            const endHandle = document.getElementById('gifEndHandle');
            const selectedRange = document.getElementById('gifSelectedRange');

            startHandle.style.left = startPercent + '%';
            endHandle.style.left = endPercent + '%';

            selectedRange.style.left = startPercent + '%';
            selectedRange.style.width = (endPercent - startPercent) + '%';

            // ì‹œê°„ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
            const formatTime = (seconds) => {
                const mins = Math.floor(seconds / 60);
                const secs = Math.floor(seconds % 60);
                return `${mins}:${String(secs).padStart(2, '0')}`;
            };

            document.getElementById('gifRangeTimeDisplay').textContent =
                `${formatTime(gifRangeState.startTime)} ~ ${formatTime(gifRangeState.endTime)}`;
            document.getElementById('gifRangeDurationDisplay').textContent =
                formatTime(gifRangeState.endTime - gifRangeState.startTime);
        }

        // GIF ë“œë˜ê·¸ ê¸°ëŠ¥ ì„¤ì •
        function setupGifTimelineDrag() {
            // ë§ˆìš°ìŠ¤ ì´ë™
            let mouseMoveHandler = (e) => {
                if (!gifRangeState.isDragging) return;

                const container = document.getElementById('gifTimelineContainer');
                const rect = container.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const percent = Math.max(0, Math.min(1, x / rect.width));
                const duration = videoPlayer.duration || 10;
                const newTime = percent * duration;

                if (gifRangeState.dragTarget === 'start') {
                    gifRangeState.startTime = Math.min(newTime, gifRangeState.endTime - 0.5);
                    videoPlayer.currentTime = gifRangeState.startTime;
                } else if (gifRangeState.dragTarget === 'end') {
                    gifRangeState.endTime = Math.max(newTime, gifRangeState.startTime + 0.5);
                    videoPlayer.currentTime = gifRangeState.endTime;
                }

                updateGifTimelineDisplay();
            };

            document.addEventListener('mousemove', mouseMoveHandler);

            // í„°ì¹˜ ì´ë™ í•¸ë“¤ëŸ¬
            let touchMoveHandler = (e) => {
                if (!gifRangeState.isDragging) return;
                e.preventDefault();

                const touch = e.touches[0];
                const container = document.getElementById('gifTimelineContainer');
                const rect = container.getBoundingClientRect();
                const x = touch.clientX - rect.left;
                const percent = Math.max(0, Math.min(1, x / rect.width));
                const duration = videoPlayer.duration || 10;
                const newTime = percent * duration;

                if (gifRangeState.dragTarget === 'start') {
                    gifRangeState.startTime = Math.min(newTime, gifRangeState.endTime - 0.5);
                    videoPlayer.currentTime = gifRangeState.startTime;
                } else if (gifRangeState.dragTarget === 'end') {
                    gifRangeState.endTime = Math.max(newTime, gifRangeState.endTime + 0.5);
                    videoPlayer.currentTime = gifRangeState.endTime;
                }

                updateGifTimelineDisplay();
            };

            document.addEventListener('touchmove', touchMoveHandler, { passive: false });

            // ë§ˆìš°ìŠ¤ ì—…
            let mouseUpHandler = () => {
                gifRangeState.isDragging = false;
                gifRangeState.dragTarget = null;
            };

            document.addEventListener('mouseup', mouseUpHandler);

            // í„°ì¹˜ ì¢…ë£Œ
            let touchEndHandler = () => {
                gifRangeState.isDragging = false;
                gifRangeState.dragTarget = null;
            };

            document.addEventListener('touchend', touchEndHandler);
            document.addEventListener('touchcancel', touchEndHandler);
        }

        // í†µí•© íƒ€ì„ë¼ì¸ì—ì„œ êµ¬ê°„ ì˜ë¼ë‚´ê¸° ì‹¤í–‰
        async function startTrimVideoIntegrated() {
            // ë¹„ë””ì˜¤ ë¡œë“œ í™•ì¸
            if (!videoPlayer.src) {
                showStatus('ë¹„ë””ì˜¤ë¥¼ ë¨¼ì € ë¡œë“œí•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            if (!videoPlayer.duration || isNaN(videoPlayer.duration) || videoPlayer.duration === Infinity) {
                showStatus('ë¹„ë””ì˜¤ê°€ ì œëŒ€ë¡œ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            const startTime = trimRangeState.startTime;
            const endTime = trimRangeState.endTime;
            const fps = parseInt(document.getElementById('trimFpsIntegrated').value) || 30;
            const bitrate = parseInt(document.getElementById('trimQualityIntegrated').value) || 8000000;

            // ìœ íš¨ì„± ê²€ì‚¬
            if (startTime >= endTime) {
                showStatus('ì‹œì‘ ì‹œê°„ì´ ì¢…ë£Œ ì‹œê°„ë³´ë‹¤ ì‘ì•„ì•¼ í•©ë‹ˆë‹¤.', 'error');
                return;
            }

            const duration = endTime - startTime;
            showStatus(`êµ¬ê°„ ì˜ë¼ë‚´ê¸° ì‹œì‘ (${startTime.toFixed(1)}ì´ˆ ~ ${endTime.toFixed(1)}ì´ˆ, ${duration.toFixed(1)}ì´ˆ)...`, 'warning');
            showProgress(0);

            try {
                const stream = canvas.captureStream(fps);
                const mediaRecorder = new MediaRecorder(stream, {
                    mimeType: 'video/webm;codecs=vp9',
                    videoBitsPerSecond: bitrate
                });

                const chunks = [];
                mediaRecorder.ondataavailable = (e) => chunks.push(e.data);

                mediaRecorder.onstop = async () => {
                    const blob = new Blob(chunks, { type: 'video/webm' });
                    const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
                    const filename = `trimmed_${timestamp}.webm`;
                    await saveFile(blob, filename);

                    hideProgress();
                    showStatus('êµ¬ê°„ ì˜ë¼ë‚´ê¸°ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
                    videoPlayer.currentTime = startTime;
                };

                canvas.width = videoPlayer.videoWidth;
                canvas.height = videoPlayer.videoHeight;

                videoPlayer.currentTime = startTime;

                let frameCount = 0;
                const totalFrames = duration * fps;

                const captureFrame = () => {
                    if (videoPlayer.currentTime >= endTime || frameCount >= totalFrames) {
                        mediaRecorder.stop();
                        return;
                    }

                    ctx.filter = getCurrentFilterString();
                    ctx.drawImage(videoPlayer, 0, 0, canvas.width, canvas.height);
                    ctx.filter = 'none';

                    frameCount++;
                    const progress = (frameCount / totalFrames) * 100;
                    showProgress(progress);

                    videoPlayer.currentTime = startTime + (frameCount / fps);
                    requestAnimationFrame(captureFrame);
                };

                videoPlayer.onseeked = () => {
                    if (frameCount === 0) {
                        mediaRecorder.start();
                        captureFrame();
                    }
                };

            } catch (error) {
                hideProgress();
                showStatus('êµ¬ê°„ ì˜ë¼ë‚´ê¸° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
                console.error(error);
            }
        }

        // ì¸ë„¤ì¼ ì˜µì…˜ í‘œì‹œ
        function showThumbnailOptions() {
            const intervalControls = document.getElementById('intervalCaptureControls');
            const gifControls = document.getElementById('gifControls');
            const trimControls = document.getElementById('trimControls');
            const thumbnailControls = document.getElementById('thumbnailControls');
            const slowMotionControls = document.getElementById('slowMotionControls');
            const reverseControls = document.getElementById('reverseControls');
            const highQualityControls = document.getElementById('highQualityControls');

            intervalControls.style.display = 'none';
            gifControls.style.display = 'none';
            trimControls.style.display = 'none';
            slowMotionControls.style.display = 'none';
            reverseControls.style.display = 'none';
            highQualityControls.style.display = 'none';
            thumbnailControls.style.display = thumbnailControls.style.display === 'none' ? 'block' : 'none';
        }

        // ì¸ë„¤ì¼ ìƒì„± ìƒíƒœ
        let thumbnailState = {
            isRunning: false,
            currentIndex: 0,
            totalCount: 0,
            thumbnails: [],
            originalTime: 0
        };

        // ì¸ë„¤ì¼ ìƒì„± ì‹œì‘
        async function startGenerateThumbnails() {
            // ë¹„ë””ì˜¤ ë¡œë“œ í™•ì¸
            if (!videoPlayer.src || !videoPlayer.duration) {
                showStatus('ë¹„ë””ì˜¤ë¥¼ ë¨¼ì € ë¡œë“œí•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            if (!videoPlayer.videoWidth || !videoPlayer.videoHeight) {
                showStatus('ë¹„ë””ì˜¤ê°€ ì œëŒ€ë¡œ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.', 'error');
                return;
            }

            // ì„¤ì • ê°€ì ¸ì˜¤ê¸°
            const count = parseInt(document.getElementById('thumbnailCount').value);
            const size = parseInt(document.getElementById('thumbnailSize').value);
            const outputMode = document.getElementById('thumbnailOutput').value;
            const format = document.getElementById('thumbnailFormat').value;
            const duration = videoPlayer.duration;

            // íƒ€ì„ìŠ¤íƒ¬í”„ ê³„ì‚° (ê· ë“± ë¶„í¬)
            const timestamps = [];
            const interval = duration / (count + 1);

            for (let i = 1; i <= count; i++) {
                timestamps.push(interval * i);
            }

            // ìƒíƒœ ì´ˆê¸°í™”
            thumbnailState = {
                isRunning: true,
                currentIndex: 0,
                totalCount: count,
                thumbnails: [],
                originalTime: videoPlayer.currentTime,
                timestamps: timestamps,
                size: size,
                outputMode: outputMode,
                format: format
            };

            showStatus(`ì¸ë„¤ì¼ ìƒì„± ì¤‘... (0/${count})`, 'info');
            updateProgress(0);

            // ì²« ë²ˆì§¸ ì¸ë„¤ì¼ ìº¡ì²˜ ì‹œì‘
            await captureNextThumbnail();
        }

        // ë‹¤ìŒ ì¸ë„¤ì¼ ìº¡ì²˜
        async function captureNextThumbnail() {
            if (!thumbnailState.isRunning || thumbnailState.currentIndex >= thumbnailState.totalCount) {
                // ëª¨ë“  ì¸ë„¤ì¼ ìº¡ì²˜ ì™„ë£Œ
                if (thumbnailState.currentIndex >= thumbnailState.totalCount) {
                    await finishThumbnailGeneration();
                }
                return;
            }

            const timestamp = thumbnailState.timestamps[thumbnailState.currentIndex];

            // seeked ì´ë²¤íŠ¸ë¡œ ìº¡ì²˜
            const seekedHandler = async () => {
                videoPlayer.removeEventListener('seeked', seekedHandler);

                try {
                    // ì¸ë„¤ì¼ ìº¡ì²˜
                    const thumbnailData = await captureThumbnailFrame();
                    thumbnailState.thumbnails.push(thumbnailData);

                    // ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
                    thumbnailState.currentIndex++;
                    const progress = thumbnailState.currentIndex / thumbnailState.totalCount;
                    updateProgress(progress);
                    showStatus(`ì¸ë„¤ì¼ ìƒì„± ì¤‘... (${thumbnailState.currentIndex}/${thumbnailState.totalCount})`, 'info');

                    // ë‹¤ìŒ ì¸ë„¤ì¼
                    await captureNextThumbnail();
                } catch (error) {
                    console.error('ì¸ë„¤ì¼ ìº¡ì²˜ ì˜¤ë¥˜:', error);
                    thumbnailState.isRunning = false;
                    showStatus('ì¸ë„¤ì¼ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                    videoPlayer.currentTime = thumbnailState.originalTime;
                }
            };

            videoPlayer.addEventListener('seeked', seekedHandler);
            videoPlayer.currentTime = timestamp;
        }

        // ì¸ë„¤ì¼ í”„ë ˆì„ ìº¡ì²˜
        async function captureThumbnailFrame() {
            return new Promise((resolve) => {
                const size = thumbnailState.size;
                const videoWidth = videoPlayer.videoWidth;
                const videoHeight = videoPlayer.videoHeight;
                const aspectRatio = videoWidth / videoHeight;

                // ì¸ë„¤ì¼ ìº”ë²„ìŠ¤ í¬ê¸° ê³„ì‚° (ì¢…íš¡ë¹„ ìœ ì§€)
                let thumbWidth, thumbHeight;
                if (aspectRatio > 1) {
                    // ê°€ë¡œê°€ ë” ê¸´ ê²½ìš°
                    thumbWidth = size;
                    thumbHeight = Math.round(size / aspectRatio);
                } else {
                    // ì„¸ë¡œê°€ ë” ê¸´ ê²½ìš°
                    thumbWidth = Math.round(size * aspectRatio);
                    thumbHeight = size;
                }

                canvas.width = thumbWidth;
                canvas.height = thumbHeight;

                const ctx = canvas.getContext('2d');
                ctx.imageSmoothingEnabled = true;
                ctx.imageSmoothingQuality = 'high';

                // í•„í„° ì ìš©
                ctx.filter = getCurrentFilterString();
                ctx.drawImage(videoPlayer, 0, 0, thumbWidth, thumbHeight);
                ctx.filter = 'none';

                // íƒ€ì„ìŠ¤íƒ¬í”„ ì¶”ê°€ (ì˜µì…˜ì´ í™œì„±í™”ëœ ê²½ìš°)
                if (document.getElementById('showTimestamp').checked) {
                    const timestamp = formatTime(videoPlayer.currentTime);
                    const fontSize = Math.max(12, Math.round(thumbHeight / 15));

                    ctx.font = `bold ${fontSize}px Arial`;
                    ctx.textAlign = 'right';
                    ctx.textBaseline = 'bottom';

                    const padding = 5;
                    const textMetrics = ctx.measureText(timestamp);
                    const textWidth = textMetrics.width;
                    const textHeight = fontSize;

                    // ë°°ê²½
                    ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
                    ctx.fillRect(
                        thumbWidth - textWidth - padding * 2,
                        thumbHeight - textHeight - padding * 2,
                        textWidth + padding * 2,
                        textHeight + padding * 2
                    );

                    // í…ìŠ¤íŠ¸
                    ctx.fillStyle = '#fff';
                    ctx.fillText(timestamp, thumbWidth - padding, thumbHeight - padding);
                }

                // Blob ìƒì„±
                const mimeType = thumbnailState.format === 'png' ? 'image/png' : 'image/jpeg';
                canvas.toBlob((blob) => {
                    resolve({
                        blob: blob,
                        timestamp: videoPlayer.currentTime,
                        index: thumbnailState.currentIndex
                    });
                }, mimeType, 0.95);
            });
        }

        // ì¸ë„¤ì¼ ìƒì„± ì™„ë£Œ
        async function finishThumbnailGeneration() {
            const outputMode = thumbnailState.outputMode;
            const format = thumbnailState.format;
            const count = thumbnailState.totalCount;

            if (outputMode === 'grid') {
                // ê·¸ë¦¬ë“œ ì´ë¯¸ì§€ ìƒì„±
                await createThumbnailGrid();
            } else {
                // ê°œë³„ ì´ë¯¸ì§€ ì €ì¥
                await saveThumbnailsIndividually();
            }

            // ì›ë˜ ì¬ìƒ ìœ„ì¹˜ë¡œ ë³µì›
            videoPlayer.currentTime = thumbnailState.originalTime;
            thumbnailState.isRunning = false;

            updateProgress(1);
            showStatus(`ì¸ë„¤ì¼ ${count}ê°œ ìƒì„± ì™„ë£Œ!`, 'success');
        }

        // ê·¸ë¦¬ë“œ ì´ë¯¸ì§€ ìƒì„±
        async function createThumbnailGrid() {
            const count = thumbnailState.totalCount;
            const size = thumbnailState.size;

            // ê·¸ë¦¬ë“œ ë ˆì´ì•„ì›ƒ ê³„ì‚°
            let cols, rows;
            switch (count) {
                case 4:
                    cols = 2; rows = 2;
                    break;
                case 6:
                    cols = 3; rows = 2;
                    break;
                case 9:
                    cols = 3; rows = 3;
                    break;
                case 12:
                    cols = 4; rows = 3;
                    break;
                case 16:
                    cols = 4; rows = 4;
                    break;
                default:
                    cols = Math.ceil(Math.sqrt(count));
                    rows = Math.ceil(count / cols);
            }

            const padding = 10;
            const videoWidth = videoPlayer.videoWidth;
            const videoHeight = videoPlayer.videoHeight;
            const aspectRatio = videoWidth / videoHeight;

            // ê°œë³„ ì¸ë„¤ì¼ í¬ê¸°
            let thumbWidth, thumbHeight;
            if (aspectRatio > 1) {
                thumbWidth = size;
                thumbHeight = Math.round(size / aspectRatio);
            } else {
                thumbWidth = Math.round(size * aspectRatio);
                thumbHeight = size;
            }

            // ê·¸ë¦¬ë“œ ìº”ë²„ìŠ¤ í¬ê¸°
            const gridWidth = cols * thumbWidth + (cols + 1) * padding;
            const gridHeight = rows * thumbHeight + (rows + 1) * padding;

            canvas.width = gridWidth;
            canvas.height = gridHeight;

            const ctx = canvas.getContext('2d');
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, gridWidth, gridHeight);

            // ê° ì¸ë„¤ì¼ì„ ê·¸ë¦¬ë“œì— ë°°ì¹˜
            for (let i = 0; i < thumbnailState.thumbnails.length; i++) {
                const col = i % cols;
                const row = Math.floor(i / cols);
                const x = padding + col * (thumbWidth + padding);
                const y = padding + row * (thumbHeight + padding);

                // ì¸ë„¤ì¼ ì´ë¯¸ì§€ ë¡œë“œ ë° ê·¸ë¦¬ê¸°
                const img = await createImageFromBlob(thumbnailState.thumbnails[i].blob);
                ctx.drawImage(img, x, y, thumbWidth, thumbHeight);
            }

            // ê·¸ë¦¬ë“œ ì´ë¯¸ì§€ ì €ì¥
            const mimeType = thumbnailState.format === 'png' ? 'image/png' : 'image/jpeg';
            canvas.toBlob(async (blob) => {
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
                const filename = `thumbnails_grid_${count}_${timestamp}.${thumbnailState.format}`;
                await saveFile(blob, filename);
            }, mimeType, 0.95);
        }

        // Blobì—ì„œ Image ìƒì„±
        function createImageFromBlob(blob) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = () => {
                    URL.revokeObjectURL(img.src);
                    resolve(img);
                };
                img.src = URL.createObjectURL(blob);
            });
        }

        // ì¸ë„¤ì¼ ê°œë³„ ì €ì¥
        async function saveThumbnailsIndividually() {
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);

            for (let i = 0; i < thumbnailState.thumbnails.length; i++) {
                const thumbData = thumbnailState.thumbnails[i];
                const paddedIndex = String(i + 1).padStart(3, '0');
                const filename = `thumbnail_${paddedIndex}_${timestamp}.${thumbnailState.format}`;

                await saveFile(thumbData.blob, filename);

                // ì €ì¥ ì‚¬ì´ì— ì•½ê°„ì˜ ì§€ì—° (ë¸Œë¼ìš°ì € ê³¼ë¶€í•˜ ë°©ì§€)
                await new Promise(resolve => setTimeout(resolve, 100));
            }
        }

        // ìŠ¬ë¡œìš° ëª¨ì…˜ ì˜µì…˜ í‘œì‹œ
        function showSlowMotionOptions() {
            const timelineSelector = document.getElementById('timelineRangeSelector');
            const intervalControls = document.getElementById('intervalCaptureControls');
            const gifControls = document.getElementById('gifControls');
            const trimControls = document.getElementById('trimControls');
            const thumbnailControls = document.getElementById('thumbnailControls');
            const slowMotionControls = document.getElementById('slowMotionControls');
            const reverseControls = document.getElementById('reverseControls');
            const highQualityControls = document.getElementById('highQualityControls');

            // ëª¨ë“  ë‹¤ë¥¸ ì˜µì…˜ ìˆ¨ê¸°ê¸°
            intervalControls.style.display = 'none';
            gifControls.style.display = 'none';
            trimControls.style.display = 'none';
            thumbnailControls.style.display = 'none';
            reverseControls.style.display = 'none';
            highQualityControls.style.display = 'none';

            // ìŠ¬ë¡œìš° ëª¨ì…˜ ì˜µì…˜ê³¼ íƒ€ì„ë¼ì¸ í† ê¸€
            if (slowMotionControls.style.display === 'none') {
                slowMotionControls.style.display = 'block';
                timelineSelector.style.display = 'block';
                initializeTimeline();
            } else {
                slowMotionControls.style.display = 'none';
                timelineSelector.style.display = 'none';
            }
        }

        // ì—­ì¬ìƒ ì˜µì…˜ í‘œì‹œ
        function showReverseOptions() {
            const intervalControls = document.getElementById('intervalCaptureControls');
            const gifControls = document.getElementById('gifControls');
            const trimControls = document.getElementById('trimControls');
            const thumbnailControls = document.getElementById('thumbnailControls');
            const reverseControls = document.getElementById('reverseControls');
            const slowMotionControls = document.getElementById('slowMotionControls');
            const highQualityControls = document.getElementById('highQualityControls');

            intervalControls.style.display = 'none';
            gifControls.style.display = 'none';
            trimControls.style.display = 'none';
            thumbnailControls.style.display = 'none';
            slowMotionControls.style.display = 'none';
            highQualityControls.style.display = 'none';
            reverseControls.style.display = reverseControls.style.display === 'none' ? 'block' : 'none';
        }

        // ê³ í™”ì§ˆ ë¹„ë””ì˜¤ ì˜µì…˜ í‘œì‹œ
        function showHighQualityOptions() {
            const intervalControls = document.getElementById('intervalCaptureControls');
            const gifControls = document.getElementById('gifControls');
            const trimControls = document.getElementById('trimControls');
            const thumbnailControls = document.getElementById('thumbnailControls');
            const reverseControls = document.getElementById('reverseControls');
            const slowMotionControls = document.getElementById('slowMotionControls');
            const highQualityControls = document.getElementById('highQualityControls');

            intervalControls.style.display = 'none';
            gifControls.style.display = 'none';
            trimControls.style.display = 'none';
            thumbnailControls.style.display = 'none';
            slowMotionControls.style.display = 'none';
            reverseControls.style.display = 'none';
            highQualityControls.style.display = highQualityControls.style.display === 'none' ? 'block' : 'none';
        }

        // ê³ í™”ì§ˆ ë¹„ë””ì˜¤ ìƒì„± ì‹œì‘
        function startHighQualityVideo() {
            generateHighQualityVideo();
        }

        // ê³ í™”ì§ˆ ë¹„ë””ì˜¤ ìƒì„± (í”„ë ˆì„ ë³´ê°„ìœ¼ë¡œ FPS ì¦ê°€)
        async function generateHighQualityVideo() {
            // ë¹„ë””ì˜¤ ë¡œë“œ í™•ì¸
            if (!videoPlayer.src) {
                showStatus('ë¹„ë””ì˜¤ë¥¼ ë¨¼ì € ë¡œë“œí•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            if (!videoPlayer.duration || isNaN(videoPlayer.duration) || videoPlayer.duration === Infinity) {
                showStatus('ë¹„ë””ì˜¤ê°€ ì œëŒ€ë¡œ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            if (!videoPlayer.videoWidth || !videoPlayer.videoHeight) {
                showStatus('ë¹„ë””ì˜¤ ë©”íƒ€ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë¡œì»¬ íŒŒì¼ì„ ì‚¬ìš©í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            // ì‚¬ìš©ì ì„¤ì • ê°€ì ¸ì˜¤ê¸°
            const targetFps = parseInt(document.getElementById('highQualityTargetFps').value) || 60;
            const quality = document.getElementById('highQualityInterpolation').value || 'high';
            const bitrate = parseInt(document.getElementById('highQualityBitrate').value) || 12000000;
            const applyFilter = document.getElementById('highQualityApplyFilter').checked;

            const totalDuration = videoPlayer.duration;

            showStatus(`ê³ í™”ì§ˆ ë¹„ë””ì˜¤ ìƒì„± ì¤‘ (${targetFps}fps, ${quality} í’ˆì§ˆ)... ì‹œê°„ì´ ê±¸ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.`, 'warning');
            showProgress(0);

            try {
                // Canvas ì„¤ì •
                const recordCanvas = document.createElement('canvas');
                recordCanvas.width = videoPlayer.videoWidth;
                recordCanvas.height = videoPlayer.videoHeight;
                const recordCtx = recordCanvas.getContext('2d');

                // MediaRecorder ì„¤ì •
                const stream = recordCanvas.captureStream(targetFps);

                let mimeType = 'video/webm;codecs=vp9';
                if (!MediaRecorder.isTypeSupported(mimeType)) {
                    mimeType = 'video/webm;codecs=vp8';
                    if (!MediaRecorder.isTypeSupported(mimeType)) {
                        mimeType = 'video/webm';
                    }
                }

                const mediaRecorder = new MediaRecorder(stream, {
                    mimeType: mimeType,
                    videoBitsPerSecond: bitrate
                });

                const chunks = [];
                mediaRecorder.ondataavailable = (e) => {
                    if (e.data.size > 0) {
                        chunks.push(e.data);
                    }
                };

                mediaRecorder.onstop = async () => {
                    const webmBlob = new Blob(chunks, { type: 'video/webm' });
                    const timestamp = new Date().toISOString().replace(/[:.]/g, '-');

                    // í¬ë§· ì„ íƒ í™•ì¸
                    const selectedFormat = document.getElementById('highQualityFormat').value;

                    if (selectedFormat === 'mp4') {
                        // MP4 ë³€í™˜
                        const loaded = await loadFFmpeg();
                        if (loaded) {
                            const mp4Blob = await convertWebMToMP4(webmBlob, `highquality_${targetFps}fps_${quality}_${timestamp}`);
                            if (mp4Blob) {
                                const filename = `highquality_${targetFps}fps_${quality}_${timestamp}.mp4`;
                                await saveFile(mp4Blob, filename);
                                hideProgress();
                                showStatus('ê³ í™”ì§ˆ ë¹„ë””ì˜¤ê°€ MP4ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
                            } else {
                                // ë³€í™˜ ì‹¤íŒ¨ ì‹œ WebM ì €ì¥
                                const filename = `highquality_${targetFps}fps_${quality}_${timestamp}.webm`;
                                await saveFile(webmBlob, filename);
                                hideProgress();
                            }
                        } else {
                            // FFmpeg ë¡œë”© ì‹¤íŒ¨ ì‹œ WebM ì €ì¥
                            const filename = `highquality_${targetFps}fps_${quality}_${timestamp}.webm`;
                            await saveFile(webmBlob, filename);
                            hideProgress();
                        }
                    } else {
                        // WebM ì €ì¥
                        const filename = `highquality_${targetFps}fps_${quality}_${timestamp}.webm`;
                        await saveFile(webmBlob, filename);
                        hideProgress();
                        showStatus('ê³ í™”ì§ˆ ë¹„ë””ì˜¤ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
                    }
                };

                // í”„ë ˆì„ ë³´ê°„ ì„¤ì •
                const originalFps = 30; // ì¼ë°˜ì ì¸ ì›ë³¸ fps (ì¶”ì •)
                const originalFrameInterval = 1 / originalFps;

                // ë³´ê°„ ìŠ¤í… ê³„ì‚°: targetFps / originalFps (ì˜ˆ: 60/30 = 2, 120/30 = 4)
                const fpsMultiplier = targetFps / originalFps;

                // ë³´ê°„ ìŠ¤í…: FPS ë°°ìœ¨ì— ë§ì¶¤ (ì¬ìƒ ì‹œê°„ ìœ ì§€)
                const interpolationSteps = Math.round(fpsMultiplier);

                console.log(`=== ê³ í™”ì§ˆ ë¹„ë””ì˜¤ ìƒì„± (í”„ë ˆì„ ë³´ê°„) ===`);
                console.log(`ì›ë³¸ FPS: ${originalFps}fps`);
                console.log(`ëª©í‘œ FPS: ${targetFps}fps (${fpsMultiplier}ë°°)`);
                console.log(`ë³´ê°„ í’ˆì§ˆ: ${quality}`);
                console.log(`ë³´ê°„ ìŠ¤í…: ${interpolationSteps}ê°œ (ì¬ìƒ ì‹œê°„ ìœ ì§€)`);
                console.log(`ì´ ë¹„ë””ì˜¤ ê¸¸ì´: ${totalDuration.toFixed(2)}ì´ˆ`);

                // ì „ì²´ ë¹„ë””ì˜¤ì— ëŒ€í•œ í”„ë ˆì„ ì‹œê°„ ë°°ì—´ ìƒì„±
                let frameTimes = [];
                const allFrameTimes = [];

                for (let t = 0; t < totalDuration; t += originalFrameInterval) {
                    allFrameTimes.push(t);
                }

                // ëª¨ë“  í”„ë ˆì„ì— ë³´ê°„ ì ìš©
                for (let i = 0; i < allFrameTimes.length; i++) {
                    const currentTime = allFrameTimes[i];
                    const nextTime = allFrameTimes[i + 1] || currentTime;

                    frameTimes.push({
                        time: currentTime,
                        nextTime: nextTime,
                        section: 'interpolated',
                        steps: interpolationSteps
                    });
                }

                const originalFrameCount = allFrameTimes.length;
                const totalOutputFrames = originalFrameCount * interpolationSteps;

                console.log(`ì›ë³¸ í”„ë ˆì„ ìˆ˜: ${originalFrameCount}ê°œ`);
                console.log(`ì¶œë ¥ í”„ë ˆì„ ìˆ˜: ${totalOutputFrames}ê°œ (${originalFrameCount} Ã— ${interpolationSteps})`);
                console.log(`ì˜ˆìƒ ì²˜ë¦¬ ì‹œê°„: ${(totalOutputFrames / targetFps).toFixed(1)}ì´ˆ ë¶„ëŸ‰`);
                console.log('========================');

                // ì´ í”„ë ˆì„ ìˆ˜ ê³„ì‚° (ë³´ê°„ í”„ë ˆì„ í¬í•¨)
                let totalFrames = frameTimes.reduce((sum, frame) => {
                    return sum + frame.steps;
                }, 0);

                let currentFrameIndex = 0;
                let currentStep = 0;
                let processedFrames = 0;

                // í”„ë ˆì„ ìº¡ì²˜ ê°„ê²©: ì›ë³¸ fps ê¸°ì¤€ (ì¬ìƒ ì‹œê°„ ìœ ì§€)
                const outputFrameInterval = 1000 / originalFps;

                // í”„ë ˆì„ ë³´ê°„ì„ ìœ„í•œ ì„ì‹œ ìº”ë²„ìŠ¤
                const prevFrameCanvas = document.createElement('canvas');
                const nextFrameCanvas = document.createElement('canvas');
                prevFrameCanvas.width = nextFrameCanvas.width = recordCanvas.width;
                prevFrameCanvas.height = nextFrameCanvas.height = recordCanvas.height;
                const prevFrameCtx = prevFrameCanvas.getContext('2d');
                const nextFrameCtx = nextFrameCanvas.getContext('2d');

                let prevFrameLoaded = false;
                let nextFrameLoaded = false;
                let waitingForSeek = false;

                const captureFrame = () => {
                    if (currentFrameIndex >= frameTimes.length) {
                        mediaRecorder.stop();
                        return;
                    }

                    const frameInfo = frameTimes[currentFrameIndex];

                    // í”„ë ˆì„ ë³´ê°„ ì²˜ë¦¬
                    if (currentStep === 0) {
                        // ì²« ë²ˆì§¸ ìŠ¤í…: í˜„ì¬ í”„ë ˆì„ê³¼ ë‹¤ìŒ í”„ë ˆì„ ë¡œë“œ
                        prevFrameLoaded = false;
                        nextFrameLoaded = false;

                        // í˜„ì¬ í”„ë ˆì„ ë¡œë“œ
                        waitingForSeek = true;
                        videoPlayer.currentTime = Math.min(frameInfo.time, totalDuration);
                    } else {
                        // ì¤‘ê°„ ìŠ¤í…: ë³´ê°„ í”„ë ˆì„ ìƒì„±
                        renderInterpolatedFrame();
                    }
                };

                const renderInterpolatedFrame = () => {
                    const frameInfo = frameTimes[currentFrameIndex];

                    // Linear alpha
                    const linearAlpha = currentStep / frameInfo.steps;

                    // Easing ì ìš©: ease-in-out cubic (íŒŒì›ŒìŠ¬ë¡œìš°ì™€ ë™ì¼)
                    const easedAlpha = easeInOutCubic(linearAlpha);

                    // ë‘ í”„ë ˆì„ì„ ë¸”ë Œë”©í•˜ì—¬ ì¤‘ê°„ í”„ë ˆì„ ìƒì„±
                    recordCtx.clearRect(0, 0, recordCanvas.width, recordCanvas.height);

                    // ê³ í’ˆì§ˆ ë Œë”ë§ ì„¤ì •
                    recordCtx.imageSmoothingEnabled = true;
                    recordCtx.imageSmoothingQuality = 'high';

                    // ë‹¨ìˆœ Alpha Blending (Motion Blur ì œê±°)
                    const blurStrength = 0;
                    const blurLayers = 1;

                    // Motion blur: ì—¬ëŸ¬ ë ˆì´ì–´ë¥¼ ê²¹ì³ì„œ ë¸”ëŸ¬ íš¨ê³¼
                    for (let layer = 0; layer < blurLayers; layer++) {
                        const layerOffset = (layer - Math.floor(blurLayers / 2)) * blurStrength;
                        const layerAlpha = Math.max(0, Math.min(1, easedAlpha + layerOffset));

                        // Prev í”„ë ˆì„ ë ˆì´ì–´
                        const prevWeight = (1 - layerAlpha) / blurLayers;
                        recordCtx.globalAlpha = prevWeight;
                        if (applyFilter) {
                            recordCtx.filter = getCurrentFilterString();
                        }
                        recordCtx.drawImage(prevFrameCanvas, 0, 0);

                        // Next í”„ë ˆì„ ë ˆì´ì–´
                        const nextWeight = layerAlpha / blurLayers;
                        recordCtx.globalAlpha = nextWeight;
                        recordCtx.drawImage(nextFrameCanvas, 0, 0);
                    }

                    // ë³µì›
                    recordCtx.globalAlpha = 1.0;
                    recordCtx.filter = 'none';

                    processedFrames++;
                    const progress = (processedFrames / totalFrames) * 100;
                    showProgress(progress);

                    currentStep++;

                    if (currentStep >= frameInfo.steps) {
                        // ë‹¤ìŒ í”„ë ˆì„ìœ¼ë¡œ
                        currentFrameIndex++;
                        currentStep = 0;
                        prevFrameLoaded = false;
                        nextFrameLoaded = false;
                    }

                    if (currentFrameIndex < frameTimes.length) {
                        // ì›ë³¸ í”„ë ˆì„ ê°„ê²©ìœ¼ë¡œ ë³´ê°„ í”„ë ˆì„ ê·¸ë£¹ ìƒì„±
                        if (currentStep === 0) {
                            // ìƒˆ ì›ë³¸ í”„ë ˆì„ ì‹œì‘: ì›ë³¸ fps ê°„ê²©ìœ¼ë¡œ ëŒ€ê¸°
                            setTimeout(() => {
                                captureFrame();
                            }, outputFrameInterval);
                        } else {
                            // ë³´ê°„ í”„ë ˆì„: ì¦‰ì‹œ ìƒì„±
                            setTimeout(() => {
                                captureFrame();
                            }, 0);
                        }
                    } else {
                        console.log('âœ… ê³ í™”ì§ˆ ë¹„ë””ì˜¤ ì²˜ë¦¬ ì™„ë£Œ!');
                        mediaRecorder.stop();
                        videoPlayer.removeEventListener('seeked', onSeeked);
                    }
                };

                const renderFrame = () => {
                    const frameInfo = frameTimes[currentFrameIndex];

                    // ë””ë²„ê¹…: í˜„ì¬ ì²˜ë¦¬ ì¤‘ì¸ í”„ë ˆì„ ì •ë³´
                    if (processedFrames % 60 === 0) {  // 60í”„ë ˆì„ë§ˆë‹¤ ë¡œê·¸
                        console.log(`ğŸ¬ í”„ë ˆì„ ${processedFrames}/${totalFrames} - ì‹œê°„: ${frameInfo.time.toFixed(2)}s (ì§„í–‰ë¥ : ${(processedFrames/totalFrames*100).toFixed(1)}%)`);
                    }

                    // í”„ë ˆì„ ì €ì¥ í›„ ë‹¤ìŒ í”„ë ˆì„ ë¡œë“œ
                    if (!prevFrameLoaded) {
                        // í˜„ì¬ í”„ë ˆì„ì„ prevFrameCanvasì— ì €ì¥
                        if (applyFilter) {
                            prevFrameCtx.filter = getCurrentFilterString();
                        }
                        prevFrameCtx.drawImage(videoPlayer, 0, 0, prevFrameCanvas.width, prevFrameCanvas.height);
                        prevFrameCtx.filter = 'none';
                        prevFrameLoaded = true;

                        // ë‹¤ìŒ í”„ë ˆì„ ë¡œë“œ
                        if (frameInfo.nextTime !== frameInfo.time) {
                            waitingForSeek = true;
                            videoPlayer.currentTime = Math.min(frameInfo.nextTime, totalDuration);
                        } else {
                            // ë§ˆì§€ë§‰ í”„ë ˆì„: nextFrameë„ í˜„ì¬ í”„ë ˆì„ ì‚¬ìš©
                            if (applyFilter) {
                                nextFrameCtx.filter = getCurrentFilterString();
                            }
                            nextFrameCtx.drawImage(videoPlayer, 0, 0, nextFrameCanvas.width, nextFrameCanvas.height);
                            nextFrameCtx.filter = 'none';
                            nextFrameLoaded = true;
                            renderInterpolatedFrame();
                        }
                    } else if (!nextFrameLoaded) {
                        // ë‹¤ìŒ í”„ë ˆì„ì„ nextFrameCanvasì— ì €ì¥
                        if (applyFilter) {
                            nextFrameCtx.filter = getCurrentFilterString();
                        }
                        nextFrameCtx.drawImage(videoPlayer, 0, 0, nextFrameCanvas.width, nextFrameCanvas.height);
                        nextFrameCtx.filter = 'none';
                        nextFrameLoaded = true;

                        // ë‘ í”„ë ˆì„ ëª¨ë‘ ë¡œë“œë¨ â†’ ë³´ê°„ ì‹œì‘
                        renderInterpolatedFrame();
                    }
                };

                const onSeeked = () => {
                    if (!waitingForSeek) return;
                    waitingForSeek = false;
                    renderFrame();
                };

                videoPlayer.addEventListener('seeked', onSeeked);

                mediaRecorder.start();
                captureFrame();

            } catch (error) {
                console.error('ê³ í™”ì§ˆ ë¹„ë””ì˜¤ ìƒì„± ì˜¤ë¥˜:', error);
                showStatus(`ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`, 'error');
                hideProgress();
            }
        }

        // íŠ¸ë¦¼ ì‹œì‘
        function startTrimVideo() {
            trimVideo();
        }

        // êµ¬ê°„ ì˜ë¼ë‚´ê¸° (íŠ¸ë¦¼) ë¹„ë””ì˜¤ ìƒì„±
        async function trimVideo() {
            // ë¹„ë””ì˜¤ ë¡œë“œ í™•ì¸
            if (!videoPlayer.src) {
                showStatus('ë¹„ë””ì˜¤ë¥¼ ë¨¼ì € ë¡œë“œí•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            // ë¹„ë””ì˜¤ê°€ ì œëŒ€ë¡œ ë¡œë“œë˜ì—ˆëŠ”ì§€ í™•ì¸
            if (!videoPlayer.duration || isNaN(videoPlayer.duration) || videoPlayer.duration === Infinity) {
                showStatus('ë¹„ë””ì˜¤ê°€ ì œëŒ€ë¡œ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            // ë¹„ë””ì˜¤ í¬ê¸° í™•ì¸
            if (!videoPlayer.videoWidth || !videoPlayer.videoHeight) {
                showStatus('ë¹„ë””ì˜¤ ë©”íƒ€ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë¡œì»¬ íŒŒì¼ì„ ì‚¬ìš©í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            // ì‚¬ìš©ì ì„¤ì • ê°€ì ¸ì˜¤ê¸°
            const startTime = parseFloat(document.getElementById('trimStartTime').value);
            const endTime = parseFloat(document.getElementById('trimEndTime').value);
            const fps = parseInt(document.getElementById('trimFps').value) || 30;
            const bitrate = parseInt(document.getElementById('trimQuality').value) || 8000000;

            // ìœ íš¨ì„± ê²€ì‚¬
            if (startTime >= endTime) {
                showStatus('ì‹œì‘ ì‹œê°„ì´ ì¢…ë£Œ ì‹œê°„ë³´ë‹¤ ì‘ì•„ì•¼ í•©ë‹ˆë‹¤.', 'error');
                return;
            }

            if (endTime > videoPlayer.duration) {
                showStatus('ì¢…ë£Œ ì‹œê°„ì´ ë¹„ë””ì˜¤ ê¸¸ì´ë¥¼ ì´ˆê³¼í•©ë‹ˆë‹¤.', 'error');
                return;
            }

            const duration = endTime - startTime;
            showStatus(`êµ¬ê°„ ì˜ë¼ë‚´ê¸° ì§„í–‰ ì¤‘ (${duration.toFixed(1)}ì´ˆ, ${fps}fps, ${(bitrate/1000000).toFixed(0)}Mbps)...`, 'warning');
            showProgress(0);

            try {
                const totalFrames = Math.floor(duration * fps);

                // Canvas ì„¤ì •
                const recordCanvas = document.createElement('canvas');
                recordCanvas.width = videoPlayer.videoWidth;
                recordCanvas.height = videoPlayer.videoHeight;
                const recordCtx = recordCanvas.getContext('2d');

                // MediaRecorder ì„¤ì •
                const stream = recordCanvas.captureStream(fps);

                // ì½”ë± ì§€ì› í™•ì¸ ë° ì„¤ì •
                let mimeType = 'video/webm;codecs=vp9';
                if (!MediaRecorder.isTypeSupported(mimeType)) {
                    mimeType = 'video/webm;codecs=vp8';
                    if (!MediaRecorder.isTypeSupported(mimeType)) {
                        mimeType = 'video/webm';
                    }
                }

                const mediaRecorder = new MediaRecorder(stream, {
                    mimeType: mimeType,
                    videoBitsPerSecond: bitrate
                });

                const chunks = [];
                mediaRecorder.ondataavailable = (e) => {
                    if (e.data.size > 0) {
                        chunks.push(e.data);
                    }
                };

                mediaRecorder.onstop = async () => {
                    const blob = new Blob(chunks, { type: 'video/webm' });
                    const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
                    const filename = `trimmed_${timestamp}.webm`;

                    await saveFile(blob, filename);
                    hideProgress();
                    showStatus('êµ¬ê°„ ì˜ë¼ë‚´ê¸°ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
                };

                // êµ¬ê°„ ìº¡ì²˜
                let currentFrame = 0;
                const frameInterval = 1 / fps;
                const frameDelayMs = 1000 / fps;
                let lastFrameTime = 0;

                const captureFrame = () => {
                    if (currentFrame >= totalFrames) {
                        mediaRecorder.stop();
                        return;
                    }

                    // ì‹œì‘ ì‹œê°„ë¶€í„° ìˆœì°¨ì ìœ¼ë¡œ ì§„í–‰
                    const time = startTime + (currentFrame * frameInterval);
                    videoPlayer.currentTime = Math.min(time, endTime);
                };

                const onSeeked = () => {
                    // í•„í„° ì ìš© ë° í˜„ì¬ í”„ë ˆì„ì„ ìº”ë²„ìŠ¤ì— ê·¸ë¦¬ê¸°
                    recordCtx.filter = getCurrentFilterString();
                    recordCtx.drawImage(videoPlayer, 0, 0, recordCanvas.width, recordCanvas.height);
                    recordCtx.filter = 'none';

                    currentFrame++;
                    const progress = (currentFrame / totalFrames) * 100;
                    showProgress(progress);

                    if (currentFrame < totalFrames) {
                        // ì •í™•í•œ í”„ë ˆì„ ê°„ê²©ìœ¼ë¡œ ë‹¤ìŒ í”„ë ˆì„ ìº¡ì²˜
                        const now = performance.now();
                        const elapsed = now - lastFrameTime;
                        const delay = Math.max(0, frameDelayMs - elapsed);

                        setTimeout(() => {
                            lastFrameTime = performance.now();
                            captureFrame();
                        }, delay);
                    } else {
                        mediaRecorder.stop();
                        videoPlayer.removeEventListener('seeked', onSeeked);
                    }
                };

                // seeked ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
                videoPlayer.addEventListener('seeked', onSeeked);

                // ë…¹í™” ì‹œì‘
                lastFrameTime = performance.now();
                mediaRecorder.start();
                captureFrame();

            } catch (error) {
                hideProgress();
                showStatus('êµ¬ê°„ ì˜ë¼ë‚´ê¸° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
                console.error(error);
            }
        }

        // ì—­ì¬ìƒ ì‹œì‘
        function startReverseVideo() {
            reverseVideo();
        }

        // ê°„ê²© ìº¡ì²˜ ê´€ë ¨ ë³€ìˆ˜
        let intervalCaptureState = {
            isRunning: false,
            currentFrame: 0,
            totalFrames: 0,
            times: [],
            format: 'jpg',
            originalTime: 0
        };

        // ê°„ê²© ì„ íƒ ë³€ê²½ ì‹œ ì»¤ìŠ¤í…€ ì…ë ¥ í•„ë“œ í‘œì‹œ/ìˆ¨ê¹€
        document.getElementById('intervalSeconds').addEventListener('change', function() {
            const customInput = document.getElementById('intervalCustomSeconds');
            if (this.value === 'custom') {
                customInput.style.display = 'block';
            } else {
                customInput.style.display = 'none';
            }
        });

        // ê°„ê²© ìº¡ì²˜ ì‹œì‘
        async function startIntervalCapture() {
            // ìœ íš¨ì„± ê²€ì‚¬
            if (!videoPlayer.src || !videoPlayer.duration) {
                showStatus('ë¹„ë””ì˜¤ë¥¼ ë¨¼ì € ë¡œë“œí•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            // ì„¤ì • ê°€ì ¸ì˜¤ê¸°
            const startTime = parseFloat(document.getElementById('intervalStartTime').value);
            let endTime = parseFloat(document.getElementById('intervalEndTime').value);
            const duration = videoPlayer.duration;

            // ì¢…ë£Œ ì‹œê°„ì´ 0ì´ë©´ ë¹„ë””ì˜¤ ëê¹Œì§€
            if (endTime === 0 || endTime > duration) {
                endTime = duration;
            }

            // ê°„ê²© ê°€ì ¸ì˜¤ê¸°
            const intervalSelect = document.getElementById('intervalSeconds');
            let interval;
            if (intervalSelect.value === 'custom') {
                interval = parseFloat(document.getElementById('intervalCustomSeconds').value);
            } else {
                interval = parseFloat(intervalSelect.value);
            }

            const format = document.getElementById('intervalFormat').value;

            // ìœ íš¨ì„± ê²€ì‚¬
            if (startTime >= endTime) {
                showStatus('ì‹œì‘ ì‹œê°„ì´ ì¢…ë£Œ ì‹œê°„ë³´ë‹¤ ì‘ì•„ì•¼ í•©ë‹ˆë‹¤.', 'error');
                return;
            }

            if (interval <= 0) {
                showStatus('ê°„ê²©ì€ 0ë³´ë‹¤ ì»¤ì•¼ í•©ë‹ˆë‹¤.', 'error');
                return;
            }

            // ìº¡ì²˜í•  ì‹œê°„ ê³„ì‚°
            const captureTimes = [];
            for (let t = startTime; t <= endTime; t += interval) {
                captureTimes.push(Math.min(t, endTime));
            }

            // ìƒíƒœ ì´ˆê¸°í™”
            intervalCaptureState = {
                isRunning: true,
                currentFrame: 0,
                totalFrames: captureTimes.length,
                times: captureTimes,
                format: format,
                originalTime: videoPlayer.currentTime
            };

            // UI ì—…ë°ì´íŠ¸
            document.getElementById('startIntervalBtn').style.display = 'none';
            document.getElementById('stopIntervalBtn').style.display = 'inline-block';
            showStatus(`${captureTimes.length}ê°œì˜ í”„ë ˆì„ì„ ìº¡ì²˜í•©ë‹ˆë‹¤...`, 'warning');
            showProgress(0);

            // ìº¡ì²˜ ì‹œì‘
            await captureNextIntervalFrame();
        }

        // ë‹¤ìŒ í”„ë ˆì„ ìº¡ì²˜
        async function captureNextIntervalFrame() {
            if (!intervalCaptureState.isRunning) {
                return;
            }

            if (intervalCaptureState.currentFrame >= intervalCaptureState.totalFrames) {
                // ì™„ë£Œ
                stopIntervalCapture(true);
                return;
            }

            const time = intervalCaptureState.times[intervalCaptureState.currentFrame];
            videoPlayer.currentTime = time;

            // seeked ì´ë²¤íŠ¸ë¥¼ í•œ ë²ˆë§Œ ì²˜ë¦¬í•˜ê¸° ìœ„í•œ í•¸ë“¤ëŸ¬
            const onSeeked = async () => {
                videoPlayer.removeEventListener('seeked', onSeeked);

                // í”„ë ˆì„ ìº¡ì²˜
                await captureFrameWithSequence(
                    intervalCaptureState.format,
                    intervalCaptureState.currentFrame + 1,
                    intervalCaptureState.totalFrames
                );

                // ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
                intervalCaptureState.currentFrame++;
                const progress = (intervalCaptureState.currentFrame / intervalCaptureState.totalFrames) * 100;
                showProgress(progress);

                // ë‹¤ìŒ í”„ë ˆì„ ìº¡ì²˜ (ì§§ì€ ì§€ì—° í›„)
                setTimeout(() => {
                    captureNextIntervalFrame();
                }, 100);
            };

            videoPlayer.addEventListener('seeked', onSeeked);
        }

        // ì‹œí€€ìŠ¤ ë²ˆí˜¸ê°€ í¬í•¨ëœ í”„ë ˆì„ ìº¡ì²˜
        async function captureFrameWithSequence(format, sequenceNumber, totalFrames) {
            // ê³ í’ˆì§ˆ ìº¡ì²˜ë¥¼ ìœ„í•œ 2ë°° ìŠ¤ì¼€ì¼ ì‚¬ìš©
            const scale = 2;
            const width = videoPlayer.videoWidth;
            const height = videoPlayer.videoHeight;

            canvas.width = width * scale;
            canvas.height = height * scale;

            // ê³ í’ˆì§ˆ ë Œë”ë§ ì„¤ì •
            ctx.imageSmoothingEnabled = true;
            ctx.imageSmoothingQuality = 'high';

            // í•„í„° ì ìš©
            ctx.filter = getCurrentFilterString();

            // ìŠ¤ì¼€ì¼ ì ìš©í•˜ì—¬ ê·¸ë¦¬ê¸°
            ctx.drawImage(videoPlayer, 0, 0, canvas.width, canvas.height);

            // í•„í„° ì´ˆê¸°í™” (í…ìŠ¤íŠ¸ì—ëŠ” í•„í„° ë¯¸ì ìš©)
            ctx.filter = 'none';

            // í…ìŠ¤íŠ¸ ì¶”ê°€ (ì…ë ¥ëœ ê²½ìš°)
            const captureText = document.getElementById('captureText').value.trim();
            if (captureText) {
                const fontSize = parseInt(document.getElementById('captureFontSize').value) * scale;
                const textColor = document.getElementById('captureTextColor').value;
                const textPosition = document.getElementById('captureTextPosition').value;
                const textStyle = document.getElementById('captureTextStyle').value;

                // í°íŠ¸ ì„¤ì •
                ctx.font = `bold ${fontSize}px Arial, sans-serif`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';

                // í…ìŠ¤íŠ¸ ìœ„ì¹˜ ê³„ì‚°
                const x = canvas.width / 2;
                let y;
                const padding = fontSize * 0.8;

                if (textPosition === 'top') {
                    y = padding;
                } else if (textPosition === 'middle') {
                    y = canvas.height / 2;
                } else { // bottom
                    y = canvas.height - padding;
                }

                const textMetrics = ctx.measureText(captureText);
                const textWidth = textMetrics.width;
                const textHeight = fontSize * 1.4;

                // í…ìŠ¤íŠ¸ ë°°ê²½ (ìŠ¤íƒ€ì¼ì— ë”°ë¼)
                if (textStyle === 'background') {
                    // ë°˜íˆ¬ëª… ê²€ì • ë°•ìŠ¤
                    ctx.fillStyle = 'rgba(0, 0, 0, 0.6)';
                    ctx.fillRect(
                        x - textWidth / 2 - fontSize * 0.5,
                        y - textHeight / 2,
                        textWidth + fontSize,
                        textHeight
                    );
                }

                // í…ìŠ¤íŠ¸ ì™¸ê³½ì„  (ê°€ë…ì„± - íˆ¬ëª… ìŠ¤íƒ€ì¼ì—ì„œ ë” ë‘ê»ê²Œ)
                ctx.strokeStyle = '#000000';
                ctx.lineWidth = textStyle === 'transparent' ? scale * 4 : scale * 3;
                ctx.strokeText(captureText, x, y);

                // í…ìŠ¤íŠ¸ ë³¸ì²´
                ctx.fillStyle = textColor;
                ctx.fillText(captureText, x, y);
            }

            // íƒ€ì„ìŠ¤íƒ¬í”„ ìë™ í‘œì‹œ
            const showTimestamp = document.getElementById('showTimestamp').checked;
            if (showTimestamp) {
                // ì‹œê°„ í¬ë§·íŒ… í•¨ìˆ˜ (HH:MM:SS.ms)
                const formatTime = (seconds) => {
                    const hours = Math.floor(seconds / 3600);
                    const minutes = Math.floor((seconds % 3600) / 60);
                    const secs = Math.floor(seconds % 60);
                    const ms = Math.floor((seconds % 1) * 100);

                    return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(secs).padStart(2, '0')}.${String(ms).padStart(2, '0')}`;
                };

                const timestamp = formatTime(videoPlayer.currentTime);
                const timestampFontSize = 28 * scale; // ê³ ì • í¬ê¸°

                // í°íŠ¸ ì„¤ì •
                ctx.font = `bold ${timestampFontSize}px 'Courier New', monospace`;
                ctx.textAlign = 'right';
                ctx.textBaseline = 'bottom';

                // ìš°ì¸¡ í•˜ë‹¨ ìœ„ì¹˜
                const tsX = canvas.width - timestampFontSize * 0.5;
                const tsY = canvas.height - timestampFontSize * 0.5;

                // í…ìŠ¤íŠ¸ í¬ê¸° ì¸¡ì •
                const tsMetrics = ctx.measureText(timestamp);
                const tsWidth = tsMetrics.width;
                const tsHeight = timestampFontSize * 1.2;

                // ë°°ê²½ ë°•ìŠ¤
                ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
                ctx.fillRect(
                    tsX - tsWidth - timestampFontSize * 0.3,
                    tsY - tsHeight + timestampFontSize * 0.2,
                    tsWidth + timestampFontSize * 0.6,
                    tsHeight
                );

                // í…ìŠ¤íŠ¸ ì™¸ê³½ì„ 
                ctx.strokeStyle = '#000000';
                ctx.lineWidth = scale * 2;
                ctx.strokeText(timestamp, tsX, tsY);

                // í…ìŠ¤íŠ¸ ë³¸ì²´
                ctx.fillStyle = '#FFFFFF';
                ctx.fillText(timestamp, tsX, tsY);
            }

            const mimeType = format === 'png' ? 'image/png' : 'image/jpeg';
            const extension = format === 'png' ? 'png' : 'jpg';

            return new Promise((resolve) => {
                canvas.toBlob(async function(blob) {
                    const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
                    const paddedNumber = String(sequenceNumber).padStart(String(totalFrames).length, '0');
                    const filename = `interval_capture_${paddedNumber}_${timestamp}.${extension}`;
                    await saveFile(blob, filename);
                    resolve();
                }, mimeType, format === 'jpg' ? 1.0 : undefined);
            });
        }

        // ê°„ê²© ìº¡ì²˜ ì¤‘ì§€
        function stopIntervalCapture(completed = false) {
            intervalCaptureState.isRunning = false;

            // UI ë³µì›
            document.getElementById('startIntervalBtn').style.display = 'inline-block';
            document.getElementById('stopIntervalBtn').style.display = 'none';

            // ì›ë˜ ì‹œê°„ìœ¼ë¡œ ë³µì›
            if (intervalCaptureState.originalTime !== undefined) {
                videoPlayer.currentTime = intervalCaptureState.originalTime;
            }

            hideProgress();

            if (completed) {
                showStatus(`${intervalCaptureState.currentFrame}ê°œì˜ í”„ë ˆì„ ìº¡ì²˜ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!`, 'success');
            } else {
                showStatus('ê°„ê²© ìº¡ì²˜ê°€ ì¤‘ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.', 'warning');
            }
        }

        // GIF ìƒì„±
        async function generateGif() {
            // íƒ€ì„ë¼ì¸ì—ì„œ ì‹œê°„ ê°’ ê°€ì ¸ì˜¤ê¸°
            const startTime = gifRangeState.startTime;
            const endTime = gifRangeState.endTime;
            const duration = endTime - startTime;

            const fps = parseInt(document.getElementById('gifFps').value);
            const width = parseInt(document.getElementById('gifWidth').value);
            const quality = parseInt(document.getElementById('gifQuality').value);

            // í’ˆì§ˆ ì •ë³´ í¬í•¨í•œ ìƒíƒœ ë©”ì‹œì§€
            const qualityText = quality === 1 ? 'ìµœê³ ' : quality === 5 ? 'ë†’ìŒ' : quality === 10 ? 'ë³´í†µ' : quality === 15 ? 'ë‚®ìŒ' : 'ìµœì†Œ';
            showStatus(`GIF ìƒì„± ì¤‘ (í’ˆì§ˆ: ${qualityText})... ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.`, 'warning');
            showProgress(0);

            try {
                const gif = new GIF({
                    workers: 2,
                    quality: quality,
                    width: width,
                    height: Math.floor((videoPlayer.videoHeight / videoPlayer.videoWidth) * width),
                    workerScript: 'gif.worker.js'
                });

                const frameCount = Math.floor(duration * fps);
                const frameDelay = 1000 / fps;

                canvas.width = width;
                canvas.height = Math.floor((videoPlayer.videoHeight / videoPlayer.videoWidth) * width);

                const originalTime = videoPlayer.currentTime;
                videoPlayer.currentTime = startTime;

                let framesAdded = 0;

                const addFrame = () => {
                    return new Promise((resolve) => {
                        if (framesAdded >= frameCount) {
                            resolve();
                            return;
                        }

                        videoPlayer.currentTime = startTime + (framesAdded / fps);

                        videoPlayer.onseeked = () => {
                            // í•„í„° ì ìš©í•˜ì—¬ ê·¸ë¦¬ê¸°
                            ctx.filter = getCurrentFilterString();
                            ctx.drawImage(videoPlayer, 0, 0, canvas.width, canvas.height);
                            ctx.filter = 'none';
                            gif.addFrame(ctx, { copy: true, delay: frameDelay });
                            framesAdded++;

                            const progress = (framesAdded / frameCount) * 100;
                            showProgress(progress);

                            if (framesAdded < frameCount) {
                                setTimeout(() => addFrame().then(resolve), 10);
                            } else {
                                resolve();
                            }
                        };
                    });
                };

                await addFrame();

                gif.on('finished', async function(blob) {
                    const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
                    const filename = `animation_${timestamp}.gif`;
                    await saveFile(blob, filename);

                    videoPlayer.currentTime = originalTime;
                    hideProgress();
                    showStatus('GIFê°€ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
                });

                gif.render();

            } catch (error) {
                hideProgress();
                showStatus('GIF ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
                console.error(error);
            }
        }

        // ìŠ¬ë¡œìš° ëª¨ì…˜ ì‹œì‘
        function startSlowMotionVideo() {
            generateSlowMotionVideo();
        }

        // ìŠ¬ë¡œìš° ëª¨ì…˜ ë¹„ë””ì˜¤ ìƒì„± (ì„ íƒ êµ¬ê°„ë§Œ ìŠ¬ë¡œìš° ì ìš©, ë‚˜ë¨¸ì§€ëŠ” ì •ìƒ ì†ë„)
        async function generateSlowMotionVideo() {
            // ë¹„ë””ì˜¤ ë¡œë“œ í™•ì¸
            if (!videoPlayer.src) {
                showStatus('ë¹„ë””ì˜¤ë¥¼ ë¨¼ì € ë¡œë“œí•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            if (!videoPlayer.duration || isNaN(videoPlayer.duration) || videoPlayer.duration === Infinity) {
                showStatus('ë¹„ë””ì˜¤ê°€ ì œëŒ€ë¡œ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            if (!videoPlayer.videoWidth || !videoPlayer.videoHeight) {
                showStatus('ë¹„ë””ì˜¤ ë©”íƒ€ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë¡œì»¬ íŒŒì¼ì„ ì‚¬ìš©í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            // ì‚¬ìš©ì ì„¤ì • ê°€ì ¸ì˜¤ê¸°
            const slowSpeed = parseFloat(document.getElementById('slowMotionSpeed').value);
            const fps = parseInt(document.getElementById('slowMotionFps').value) || 60;
            const bitrate = parseInt(document.getElementById('slowMotionQuality').value) || 8000000;

            // íƒ€ì„ë¼ì¸ì—ì„œ ìŠ¬ë¡œìš° êµ¬ê°„ ê°€ì ¸ì˜¤ê¸°
            const slowStartTime = trimRangeState.startTime;
            const slowEndTime = trimRangeState.endTime;
            const totalDuration = videoPlayer.duration;

            if (slowStartTime >= slowEndTime) {
                showStatus('ìŠ¬ë¡œìš° ëª¨ì…˜ êµ¬ê°„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            showStatus(`ìŠ¬ë¡œìš° ëª¨ì…˜ ë¹„ë””ì˜¤ ìƒì„± ì¤‘ (${slowSpeed}x ì†ë„, ${fps}fps)... ì‹œê°„ì´ ê±¸ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.`, 'warning');
            showProgress(0);

            try {
                // Canvas ì„¤ì •
                const recordCanvas = document.createElement('canvas');
                recordCanvas.width = videoPlayer.videoWidth;
                recordCanvas.height = videoPlayer.videoHeight;
                const recordCtx = recordCanvas.getContext('2d');

                // MediaRecorder ì„¤ì •
                const stream = recordCanvas.captureStream(fps);

                let mimeType = 'video/webm;codecs=vp9';
                if (!MediaRecorder.isTypeSupported(mimeType)) {
                    mimeType = 'video/webm;codecs=vp8';
                    if (!MediaRecorder.isTypeSupported(mimeType)) {
                        mimeType = 'video/webm';
                    }
                }

                const mediaRecorder = new MediaRecorder(stream, {
                    mimeType: mimeType,
                    videoBitsPerSecond: bitrate
                });

                const chunks = [];
                mediaRecorder.ondataavailable = (e) => {
                    if (e.data.size > 0) {
                        chunks.push(e.data);
                    }
                };

                mediaRecorder.onstop = async () => {
                    const webmBlob = new Blob(chunks, { type: 'video/webm' });
                    const timestamp = new Date().toISOString().replace(/[:.]/g, '-');

                    // í¬ë§· ì„ íƒ í™•ì¸
                    const selectedFormat = document.getElementById('slowMotionFormat').value;

                    if (selectedFormat === 'mp4') {
                        // MP4 ë³€í™˜
                        const loaded = await loadFFmpeg();
                        if (loaded) {
                            const mp4Blob = await convertWebMToMP4(webmBlob, `slowmotion_${slowSpeed}x_${timestamp}`);
                            if (mp4Blob) {
                                const filename = `slowmotion_${slowSpeed}x_${timestamp}.mp4`;
                                await saveFile(mp4Blob, filename);
                                hideProgress();
                                showStatus('ìŠ¬ë¡œìš° ëª¨ì…˜ ë¹„ë””ì˜¤ê°€ MP4ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
                            } else {
                                // ë³€í™˜ ì‹¤íŒ¨ ì‹œ WebM ì €ì¥
                                const filename = `slowmotion_${slowSpeed}x_${timestamp}.webm`;
                                await saveFile(webmBlob, filename);
                                hideProgress();
                            }
                        } else {
                            // FFmpeg ë¡œë”© ì‹¤íŒ¨ ì‹œ WebM ì €ì¥
                            const filename = `slowmotion_${slowSpeed}x_${timestamp}.webm`;
                            await saveFile(webmBlob, filename);
                            hideProgress();
                        }
                    } else {
                        // WebM ì €ì¥
                        const filename = `slowmotion_${slowSpeed}x_${timestamp}.webm`;
                        await saveFile(webmBlob, filename);
                        hideProgress();
                        showStatus('ìŠ¬ë¡œìš° ëª¨ì…˜ ë¹„ë””ì˜¤ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
                    }
                };

                // í”„ë ˆì„ ë³´ê°„(Frame Interpolation) ë°©ì‹ìœ¼ë¡œ ìŠ¬ë¡œìš° ëª¨ì…˜ ìƒì„±
                // - ì •ìƒ êµ¬ê°„: ì›ë³¸ í”„ë ˆì„ ê·¸ëŒ€ë¡œ (ì›ë³¸ fps ìœ ì§€)
                // - ìŠ¬ë¡œìš° êµ¬ê°„: í”„ë ˆì„ ì‚¬ì´ì— ì¤‘ê°„ í”„ë ˆì„ ë³´ê°„ (ë¶€ë“œëŸ¬ìš´ ìŠ¬ë¡œìš°)

                const frameInterval = 1 / fps;
                // ë³´ê°„ ìŠ¤í… ìˆ˜: ë‹¨ìˆœ ë³´ê°„ 4ê°œ (ë–¨ë¦¼ ë°©ì§€)
                const interpolationSteps = 4;

                console.log(`ìŠ¬ë¡œìš° ì†ë„: ${slowSpeed}x â†’ ë³´ê°„ ìŠ¤í…: ${interpolationSteps} (ë‹¨ìˆœ ë³´ê°„)`);

                // ì›ë³¸ í”„ë ˆì„ ì‹œê°„ ë°°ì—´ ìƒì„±
                const originalFps = 30; // ì¼ë°˜ì ì¸ ì›ë³¸ fps (ì¶”ì •)
                const originalFrameInterval = 1 / originalFps;

                let frameTimes = [];

                // ë””ë²„ê¹…: êµ¬ê°„ ì •ë³´ ì¶œë ¥
                console.log('=== ìŠ¬ë¡œìš° ëª¨ì…˜ êµ¬ê°„ ì •ë³´ (í”„ë ˆì„ ë³´ê°„) ===');
                console.log(`ì´ ë¹„ë””ì˜¤ ê¸¸ì´: ${totalDuration.toFixed(2)}ì´ˆ`);
                console.log(`ìŠ¬ë¡œìš° ì‹œì‘: ${slowStartTime.toFixed(2)}ì´ˆ`);
                console.log(`ìŠ¬ë¡œìš° ì¢…ë£Œ: ${slowEndTime.toFixed(2)}ì´ˆ`);
                console.log(`ìŠ¬ë¡œìš° ì†ë„: ${slowSpeed}x (ë³´ê°„ ìŠ¤í…: ${interpolationSteps})`);

                // êµ¬ê°„ 1: ì •ìƒ ì†ë„ (ì›ë³¸ í”„ë ˆì„ ì‚¬ìš©)
                let section1Count = 0;
                for (let t = 0; t < slowStartTime; t += originalFrameInterval) {
                    frameTimes.push({
                        time: t,
                        section: 'normal'
                    });
                    section1Count++;
                }

                // êµ¬ê°„ 2: ìŠ¬ë¡œìš° ëª¨ì…˜ (í”„ë ˆì„ ë³´ê°„)
                let section2Count = 0;
                const slowFrameTimes = [];
                for (let t = slowStartTime; t < slowEndTime; t += originalFrameInterval) {
                    slowFrameTimes.push(t);
                }

                // ìŠ¬ë¡œìš° êµ¬ê°„ì˜ ê° í”„ë ˆì„ ìŒ ì‚¬ì´ì— ë³´ê°„
                for (let i = 0; i < slowFrameTimes.length; i++) {
                    const currentTime = slowFrameTimes[i];
                    const nextTime = slowFrameTimes[i + 1] || currentTime;

                    frameTimes.push({
                        time: currentTime,
                        nextTime: nextTime,
                        section: 'slow',
                        steps: interpolationSteps  // ì¤‘ê°„ í”„ë ˆì„ ê°œìˆ˜ (3ë°° ì¦ê°€)
                    });
                    section2Count++;
                }

                // êµ¬ê°„ 3: ì •ìƒ ì†ë„ (ì›ë³¸ í”„ë ˆì„ ì‚¬ìš©)
                let section3Count = 0;
                for (let t = slowEndTime; t < totalDuration; t += originalFrameInterval) {
                    frameTimes.push({
                        time: t,
                        section: 'normal'
                    });
                    section3Count++;
                }

                console.log(`êµ¬ê°„ 1 (ì •ìƒ): ${section1Count}ê°œ í”„ë ˆì„`);
                console.log(`êµ¬ê°„ 2 (ìŠ¬ë¡œìš° + ë³´ê°„): ${section2Count}ê°œ ì›ë³¸ í”„ë ˆì„ (ê° ${interpolationSteps}ê°œ ë³´ê°„)`);
                console.log(`êµ¬ê°„ 3 (ì •ìƒ): ${section3Count}ê°œ í”„ë ˆì„`);
                console.log(`ì´ í”„ë ˆì„ ìˆ˜: ${frameTimes.length}ê°œ`);
                console.log(`ì˜ˆìƒ ì¶œë ¥ í”„ë ˆì„: ${section1Count + section2Count * interpolationSteps + section3Count}ê°œ`);

                // êµ¬ê°„ë³„ ìƒì„¸ ì •ë³´
                const normalFrames = section1Count + section3Count;
                const slowFrames = section2Count * interpolationSteps;
                console.log(`\nğŸ“Š ìƒì„¸ ë¶„ì„:`);
                console.log(`  ì •ìƒ êµ¬ê°„ ì´: ${normalFrames}ê°œ í”„ë ˆì„ (êµ¬ê°„1: ${section1Count}, êµ¬ê°„3: ${section3Count})`);
                console.log(`  ìŠ¬ë¡œìš° êµ¬ê°„: ${slowFrames}ê°œ í”„ë ˆì„ (${section2Count} Ã— ${interpolationSteps})`);
                console.log(`  ì „ì²´ ì¶œë ¥: ${normalFrames + slowFrames}ê°œ í”„ë ˆì„`);
                console.log('========================');

                // ì´ í”„ë ˆì„ ìˆ˜ ê³„ì‚° (ë³´ê°„ í”„ë ˆì„ í¬í•¨)
                let totalFrames = frameTimes.reduce((sum, frame) => {
                    if (frame.section === 'slow') {
                        return sum + frame.steps;
                    } else {
                        return sum + 1;
                    }
                }, 0);

                let currentFrameIndex = 0;
                let currentStep = 0; // í˜„ì¬ ë³´ê°„ ìŠ¤í…
                let processedFrames = 0;

                // í”„ë ˆì„ ìº¡ì²˜ ê°„ê²© (ms)
                const outputFrameInterval = 1000 / fps;

                // í”„ë ˆì„ ë³´ê°„ì„ ìœ„í•œ ì„ì‹œ ìº”ë²„ìŠ¤
                const prevFrameCanvas = document.createElement('canvas');
                const nextFrameCanvas = document.createElement('canvas');
                prevFrameCanvas.width = nextFrameCanvas.width = recordCanvas.width;
                prevFrameCanvas.height = nextFrameCanvas.height = recordCanvas.height;
                const prevFrameCtx = prevFrameCanvas.getContext('2d');
                const nextFrameCtx = nextFrameCanvas.getContext('2d');

                let prevFrameLoaded = false;
                let nextFrameLoaded = false;
                let waitingForSeek = false;

                const captureFrame = () => {
                    if (currentFrameIndex >= frameTimes.length) {
                        mediaRecorder.stop();
                        return;
                    }

                    const frameInfo = frameTimes[currentFrameIndex];

                    if (frameInfo.section === 'normal') {
                        // ì •ìƒ êµ¬ê°„: ë°”ë¡œ í”„ë ˆì„ ë¡œë“œ
                        waitingForSeek = true;
                        videoPlayer.currentTime = Math.min(frameInfo.time, totalDuration);
                    } else if (frameInfo.section === 'slow') {
                        // ìŠ¬ë¡œìš° êµ¬ê°„: í”„ë ˆì„ ë³´ê°„ ì²˜ë¦¬
                        if (currentStep === 0) {
                            // ì²« ë²ˆì§¸ ìŠ¤í…: í˜„ì¬ í”„ë ˆì„ê³¼ ë‹¤ìŒ í”„ë ˆì„ ë¡œë“œ
                            prevFrameLoaded = false;
                            nextFrameLoaded = false;

                            // í˜„ì¬ í”„ë ˆì„ ë¡œë“œ
                            waitingForSeek = true;
                            videoPlayer.currentTime = Math.min(frameInfo.time, totalDuration);
                        } else {
                            // ì¤‘ê°„ ìŠ¤í…: ë³´ê°„ í”„ë ˆì„ ìƒì„±
                            renderInterpolatedFrame();
                        }
                    }
                };

                const renderInterpolatedFrame = () => {
                    const frameInfo = frameTimes[currentFrameIndex];

                    // Linear alpha
                    const linearAlpha = currentStep / frameInfo.steps;

                    // Easing ì ìš©: íŒŒì›ŒìŠ¬ë¡œìš°ì™€ ë™ì¼í•œ ease-in-out cubic
                    const easedAlpha = easeInOutCubic(linearAlpha);

                    // ë‘ í”„ë ˆì„ì„ ë¸”ë Œë”©í•˜ì—¬ ì¤‘ê°„ í”„ë ˆì„ ìƒì„±
                    recordCtx.clearRect(0, 0, recordCanvas.width, recordCanvas.height);

                    // ê³ í’ˆì§ˆ ë Œë”ë§ ì„¤ì •
                    recordCtx.imageSmoothingEnabled = true;
                    recordCtx.imageSmoothingQuality = 'high';

                    // ë‹¨ìˆœ Alpha Blending (Motion Blur ì œê±°)
                    const blurStrength = 0;
                    const blurLayers = 1;

                    // Motion blur: ì—¬ëŸ¬ ë ˆì´ì–´ë¥¼ ê²¹ì³ì„œ ë¸”ëŸ¬ íš¨ê³¼
                    for (let layer = 0; layer < blurLayers; layer++) {
                        const layerOffset = (layer - Math.floor(blurLayers / 2)) * blurStrength;
                        const layerAlpha = Math.max(0, Math.min(1, easedAlpha + layerOffset));

                        // Prev í”„ë ˆì„ ë ˆì´ì–´
                        const prevWeight = (1 - layerAlpha) / blurLayers;
                        recordCtx.globalAlpha = prevWeight;
                        recordCtx.filter = getCurrentFilterString();
                        recordCtx.drawImage(prevFrameCanvas, 0, 0);

                        // Next í”„ë ˆì„ ë ˆì´ì–´
                        const nextWeight = layerAlpha / blurLayers;
                        recordCtx.globalAlpha = nextWeight;
                        recordCtx.drawImage(nextFrameCanvas, 0, 0);
                    }

                    // ë³µì›
                    recordCtx.globalAlpha = 1.0;
                    recordCtx.filter = 'none';

                    processedFrames++;
                    const progress = (processedFrames / totalFrames) * 100;
                    showProgress(progress);

                    currentStep++;

                    if (currentStep >= frameInfo.steps) {
                        // ë‹¤ìŒ í”„ë ˆì„ìœ¼ë¡œ
                        currentFrameIndex++;
                        currentStep = 0;
                        // í”Œë˜ê·¸ ì´ˆê¸°í™” (ë‹¤ìŒ ìŠ¬ë¡œìš° í”„ë ˆì„ ë˜ëŠ” ì •ìƒ êµ¬ê°„ ì§„ì… ì¤€ë¹„)
                        prevFrameLoaded = false;
                        nextFrameLoaded = false;
                    }

                    if (currentFrameIndex < frameTimes.length) {
                        setTimeout(() => {
                            captureFrame();
                        }, outputFrameInterval);
                    } else {
                        console.log('âœ… ëª¨ë“  í”„ë ˆì„ ì²˜ë¦¬ ì™„ë£Œ!');
                        mediaRecorder.stop();
                        videoPlayer.removeEventListener('seeked', onSeeked);
                    }
                };

                const renderFrame = () => {
                    const frameInfo = frameTimes[currentFrameIndex];

                    // ë””ë²„ê¹…: í˜„ì¬ ì²˜ë¦¬ ì¤‘ì¸ í”„ë ˆì„ ì •ë³´
                    if (processedFrames % 30 === 0) {  // 30í”„ë ˆì„ë§ˆë‹¤ ë¡œê·¸
                        console.log(`ğŸ¬ í”„ë ˆì„ ${processedFrames}/${totalFrames} - êµ¬ê°„: ${frameInfo.section}, ì‹œê°„: ${frameInfo.time.toFixed(2)}s`);
                    }

                    if (frameInfo.section === 'normal') {
                        // ì •ìƒ êµ¬ê°„: ë°”ë¡œ ê·¸ë¦¬ê¸°
                        // ìŠ¬ë¡œìš° êµ¬ê°„ í”Œë˜ê·¸ ì´ˆê¸°í™” (êµ¬ê°„ ì „í™˜ ì‹œ)
                        prevFrameLoaded = false;
                        nextFrameLoaded = false;

                        recordCtx.filter = getCurrentFilterString();
                        recordCtx.drawImage(videoPlayer, 0, 0, recordCanvas.width, recordCanvas.height);
                        recordCtx.filter = 'none';

                        processedFrames++;
                        const progress = (processedFrames / totalFrames) * 100;
                        showProgress(progress);

                        currentFrameIndex++;

                        if (currentFrameIndex < frameTimes.length) {
                            setTimeout(() => {
                                captureFrame();
                            }, outputFrameInterval);
                        } else {
                            console.log('âœ… ëª¨ë“  í”„ë ˆì„ ì²˜ë¦¬ ì™„ë£Œ!');
                            mediaRecorder.stop();
                            videoPlayer.removeEventListener('seeked', onSeeked);
                        }
                    } else if (frameInfo.section === 'slow') {
                        // ìŠ¬ë¡œìš° êµ¬ê°„: í”„ë ˆì„ ì €ì¥ í›„ ë‹¤ìŒ í”„ë ˆì„ ë¡œë“œ
                        if (!prevFrameLoaded) {
                            // í˜„ì¬ í”„ë ˆì„ì„ prevFrameCanvasì— ì €ì¥
                            prevFrameCtx.filter = getCurrentFilterString();
                            prevFrameCtx.drawImage(videoPlayer, 0, 0, prevFrameCanvas.width, prevFrameCanvas.height);
                            prevFrameCtx.filter = 'none';
                            prevFrameLoaded = true;

                            // ë‹¤ìŒ í”„ë ˆì„ ë¡œë“œ
                            if (frameInfo.nextTime !== frameInfo.time) {
                                waitingForSeek = true;
                                videoPlayer.currentTime = Math.min(frameInfo.nextTime, totalDuration);
                            } else {
                                // ë§ˆì§€ë§‰ í”„ë ˆì„ì¸ ê²½ìš° ìê¸° ìì‹ ê³¼ ë¸”ë Œë”©
                                nextFrameCtx.drawImage(prevFrameCanvas, 0, 0);
                                nextFrameLoaded = true;
                                currentStep = 0;
                                renderInterpolatedFrame();
                            }
                        } else if (!nextFrameLoaded) {
                            // ë‹¤ìŒ í”„ë ˆì„ì„ nextFrameCanvasì— ì €ì¥
                            nextFrameCtx.filter = getCurrentFilterString();
                            nextFrameCtx.drawImage(videoPlayer, 0, 0, nextFrameCanvas.width, nextFrameCanvas.height);
                            nextFrameCtx.filter = 'none';
                            nextFrameLoaded = true;

                            // ë³´ê°„ í”„ë ˆì„ ìƒì„± ì‹œì‘
                            currentStep = 0;
                            renderInterpolatedFrame();
                        }
                    }
                };

                const onSeeked = () => {
                    if (waitingForSeek) {
                        waitingForSeek = false;
                        renderFrame();
                    }
                };

                // seeked ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
                videoPlayer.addEventListener('seeked', onSeeked);

                // ë…¹í™” ì‹œì‘
                mediaRecorder.start();
                captureFrame();

            } catch (error) {
                hideProgress();
                showStatus('ìŠ¬ë¡œìš° ëª¨ì…˜ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
                console.error(error);
            }
        }

        // ì—­ì¬ìƒ ë¹„ë””ì˜¤ ìƒì„± (Canvas + MediaRecorder ì‚¬ìš©)
        async function reverseVideo() {
            // ë¹„ë””ì˜¤ ë¡œë“œ í™•ì¸
            if (!videoPlayer.src) {
                showStatus('ë¹„ë””ì˜¤ë¥¼ ë¨¼ì € ë¡œë“œí•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            // ë¹„ë””ì˜¤ê°€ ì œëŒ€ë¡œ ë¡œë“œë˜ì—ˆëŠ”ì§€ í™•ì¸
            if (!videoPlayer.duration || isNaN(videoPlayer.duration) || videoPlayer.duration === Infinity) {
                showStatus('ë¹„ë””ì˜¤ê°€ ì œëŒ€ë¡œ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            // ë¹„ë””ì˜¤ í¬ê¸° í™•ì¸
            if (!videoPlayer.videoWidth || !videoPlayer.videoHeight) {
                showStatus('ë¹„ë””ì˜¤ ë©”íƒ€ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë¡œì»¬ íŒŒì¼ì„ ì‚¬ìš©í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            // ì‚¬ìš©ì ì„¤ì • ê°€ì ¸ì˜¤ê¸°
            const fps = parseInt(document.getElementById('reverseFps').value) || 60;
            const bitrate = parseInt(document.getElementById('reverseQuality').value) || 8000000;

            showStatus(`ì—­ì¬ìƒ ë¹„ë””ì˜¤ ìƒì„± ì¤‘ (${fps}fps, ${(bitrate/1000000).toFixed(0)}Mbps)... ì´ ì‘ì—…ì€ ì‹œê°„ì´ ê±¸ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.`, 'warning');
            showProgress(0);

            try {
                // ë¹„ë””ì˜¤ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                const duration = videoPlayer.duration;
                const totalFrames = Math.floor(duration * fps);

                // Canvas ì„¤ì •
                const recordCanvas = document.createElement('canvas');
                recordCanvas.width = videoPlayer.videoWidth;
                recordCanvas.height = videoPlayer.videoHeight;
                const recordCtx = recordCanvas.getContext('2d');

                // MediaRecorder ì„¤ì •
                const stream = recordCanvas.captureStream(fps);

                // ì½”ë± ì§€ì› í™•ì¸ ë° ì„¤ì •
                let mimeType = 'video/webm;codecs=vp9';
                if (!MediaRecorder.isTypeSupported(mimeType)) {
                    mimeType = 'video/webm;codecs=vp8';
                    if (!MediaRecorder.isTypeSupported(mimeType)) {
                        mimeType = 'video/webm';
                    }
                }

                const mediaRecorder = new MediaRecorder(stream, {
                    mimeType: mimeType,
                    videoBitsPerSecond: bitrate
                });

                const chunks = [];
                mediaRecorder.ondataavailable = (e) => {
                    if (e.data.size > 0) {
                        chunks.push(e.data);
                    }
                };

                mediaRecorder.onstop = async () => {
                    const webmBlob = new Blob(chunks, { type: 'video/webm' });
                    const timestamp = new Date().toISOString().replace(/[:.]/g, '-');

                    // í¬ë§· ì„ íƒ í™•ì¸
                    const selectedFormat = document.getElementById('reverseFormat').value;

                    if (selectedFormat === 'mp4') {
                        // MP4 ë³€í™˜
                        const loaded = await loadFFmpeg();
                        if (loaded) {
                            const mp4Blob = await convertWebMToMP4(webmBlob, `reversed_${timestamp}`);
                            if (mp4Blob) {
                                const filename = `reversed_${timestamp}.mp4`;
                                await saveFile(mp4Blob, filename);
                                hideProgress();
                                showStatus('ì—­ì¬ìƒ ë¹„ë””ì˜¤ê°€ MP4ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
                            } else {
                                // ë³€í™˜ ì‹¤íŒ¨ ì‹œ WebM ì €ì¥
                                const filename = `reversed_${timestamp}.webm`;
                                await saveFile(webmBlob, filename);
                                hideProgress();
                            }
                        } else {
                            // FFmpeg ë¡œë”© ì‹¤íŒ¨ ì‹œ WebM ì €ì¥
                            const filename = `reversed_${timestamp}.webm`;
                            await saveFile(webmBlob, filename);
                            hideProgress();
                        }
                    } else {
                        // WebM ì €ì¥
                        const filename = `reversed_${timestamp}.webm`;
                        await saveFile(webmBlob, filename);
                        hideProgress();
                        showStatus('ì—­ì¬ìƒ ë¹„ë””ì˜¤ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
                    }
                };

                // ì—­ì¬ìƒ í”„ë ˆì„ ìº¡ì²˜
                let currentFrame = 0;
                const frameInterval = 1 / fps;
                const frameDelayMs = 1000 / fps; // í”„ë ˆì„ë‹¹ ë°€ë¦¬ì´ˆ
                let lastFrameTime = 0;
                let animationId = null;

                const captureFrame = () => {
                    if (currentFrame >= totalFrames) {
                        mediaRecorder.stop();
                        return;
                    }

                    // ì—­ìˆœìœ¼ë¡œ ì‹œê°„ ì„¤ì • (ëì—ì„œ ì‹œì‘)
                    const time = duration - (currentFrame * frameInterval);
                    videoPlayer.currentTime = Math.max(0, Math.min(time, duration));
                };

                const onSeeked = () => {
                    // í•„í„° ì ìš© ë° í˜„ì¬ í”„ë ˆì„ì„ ìº”ë²„ìŠ¤ì— ê·¸ë¦¬ê¸°
                    recordCtx.filter = getCurrentFilterString();
                    recordCtx.drawImage(videoPlayer, 0, 0, recordCanvas.width, recordCanvas.height);
                    recordCtx.filter = 'none';

                    currentFrame++;
                    const progress = (currentFrame / totalFrames) * 100;
                    showProgress(progress);

                    if (currentFrame < totalFrames) {
                        // ì •í™•í•œ í”„ë ˆì„ ê°„ê²©ìœ¼ë¡œ ë‹¤ìŒ í”„ë ˆì„ ìº¡ì²˜
                        const now = performance.now();
                        const elapsed = now - lastFrameTime;
                        const delay = Math.max(0, frameDelayMs - elapsed);

                        setTimeout(() => {
                            lastFrameTime = performance.now();
                            captureFrame();
                        }, delay);
                    } else {
                        mediaRecorder.stop();
                        videoPlayer.removeEventListener('seeked', onSeeked);
                    }
                };

                // seeked ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
                videoPlayer.addEventListener('seeked', onSeeked);

                // ë…¹í™” ì‹œì‘
                lastFrameTime = performance.now();
                mediaRecorder.start();
                captureFrame();

            } catch (error) {
                hideProgress();
                showStatus('ì—­ì¬ìƒ ë¹„ë””ì˜¤ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
                console.error(error);
            }
        }

        // ìƒíƒœ ë©”ì‹œì§€ í‘œì‹œ
        function showStatus(message, type = 'info') {
            const statusEl = document.getElementById('statusMessage');
            statusEl.textContent = message;
            statusEl.className = 'status show ' + type;

            setTimeout(() => {
                statusEl.classList.remove('show');
            }, 5000);
        }

        // ì§„í–‰ë¥  í‘œì‹œ
        function showProgress(percent) {
            const progressContainer = document.getElementById('progressContainer');
            const progressFill = document.getElementById('progressFill');
            progressContainer.classList.add('show');
            progressFill.style.width = percent + '%';
            progressFill.textContent = Math.round(percent) + '%';
        }

        // ì§„í–‰ë¥  ìˆ¨ê¸°ê¸°
        function hideProgress() {
            const progressContainer = document.getElementById('progressContainer');
            progressContainer.classList.remove('show');
        }

        // ë¹„ë””ì˜¤ ë©”íƒ€ë°ì´í„° ë¡œë“œ ì™„ë£Œ ì‹œ
        videoPlayer.addEventListener('loadedmetadata', function() {
            console.log('ë¹„ë””ì˜¤ ë¡œë“œ ì™„ë£Œ:', {
                duration: videoPlayer.duration,
                width: videoPlayer.videoWidth,
                height: videoPlayer.videoHeight
            });
            // í•„í„° ì ìš©
            applyVideoFilter();
        });

        // í•„í„° CSS ë¬¸ìì—´ ìƒì„±
        function getCurrentFilterString() {
            return `brightness(${filterState.brightness}%) contrast(${filterState.contrast}%) saturate(${filterState.saturation}%) hue-rotate(${filterState.hue}deg) blur(${filterState.blur}px) grayscale(${filterState.grayscale}%)`;
        }

        // ë¹„ë””ì˜¤ í”Œë ˆì´ì–´ì— í•„í„° ì ìš©
        function applyVideoFilter() {
            const filterString = getCurrentFilterString();
            videoPlayer.style.filter = filterString;
        }

        // í•„í„° í”„ë¦¬ì…‹ ì ìš©
        function applyFilterPreset(preset) {
            switch (preset) {
                case 'none':
                    filterState = { brightness: 100, contrast: 100, saturation: 100, hue: 0, blur: 0, grayscale: 0 };
                    break;
                case 'bw':
                    filterState = { brightness: 100, contrast: 110, saturation: 0, hue: 0, blur: 0, grayscale: 100 };
                    break;
                case 'sepia':
                    filterState = { brightness: 110, contrast: 90, saturation: 50, hue: 20, blur: 0, grayscale: 50 };
                    break;
                case 'vintage':
                    filterState = { brightness: 110, contrast: 120, saturation: 80, hue: 10, blur: 0.5, grayscale: 20 };
                    break;
                case 'vivid':
                    filterState = { brightness: 110, contrast: 120, saturation: 150, hue: 0, blur: 0, grayscale: 0 };
                    break;
            }

            // UI ì—…ë°ì´íŠ¸
            document.getElementById('filterBrightness').value = filterState.brightness;
            document.getElementById('filterContrast').value = filterState.contrast;
            document.getElementById('filterSaturation').value = filterState.saturation;
            document.getElementById('filterHue').value = filterState.hue;
            document.getElementById('filterBlur').value = filterState.blur;
            document.getElementById('filterGrayscale').value = filterState.grayscale;

            updateFilterValues();
            applyVideoFilter();
        }

        // í•„í„° ê°’ í‘œì‹œ ì—…ë°ì´íŠ¸
        function updateFilterValues() {
            document.getElementById('brightnessValue').textContent = filterState.brightness;
            document.getElementById('contrastValue').textContent = filterState.contrast;
            document.getElementById('saturationValue').textContent = filterState.saturation;
            document.getElementById('hueValue').textContent = filterState.hue;
            document.getElementById('blurValue').textContent = filterState.blur;
            document.getElementById('grayscaleValue').textContent = filterState.grayscale;
        }

        // í•„í„° ìŠ¬ë¼ì´ë” ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
        ['filterBrightness', 'filterContrast', 'filterSaturation', 'filterHue', 'filterBlur', 'filterGrayscale'].forEach(id => {
            const element = document.getElementById(id);
            if (element) {
                element.addEventListener('input', function() {
                    const key = id.replace('filter', '').toLowerCase();
                    filterState[key] = parseFloat(this.value);
                    updateFilterValues();
                    applyVideoFilter();
                });
            }
        });

        // í…ìŠ¤íŠ¸ í”„ë¦¬ë·° ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateTextPreview() {
            // ë¹„ë””ì˜¤ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìœ¼ë©´ ì¢…ë£Œ
            if (!videoPlayer.videoWidth || videoPlayer.videoWidth === 0) {
                return;
            }

            // Canvas í¬ê¸°ë¥¼ ë¹„ë””ì˜¤ì— ë§ì¶¤
            previewCanvas.width = videoPlayer.videoWidth;
            previewCanvas.height = videoPlayer.videoHeight;

            // ìº”ë²„ìŠ¤ ì´ˆê¸°í™”
            previewCtx.clearRect(0, 0, previewCanvas.width, previewCanvas.height);

            // í…ìŠ¤íŠ¸ ê°€ì ¸ì˜¤ê¸°
            const captureText = document.getElementById('captureText').value.trim();
            const showTimestamp = document.getElementById('showTimestamp').checked;

            if (!captureText && !showTimestamp) {
                return; // í‘œì‹œí•  ê²ƒì´ ì—†ìœ¼ë©´ ì¢…ë£Œ
            }

            const scale = 1; // ì‹¤ì œ ë¹„ë””ì˜¤ í¬ê¸° ê¸°ì¤€

            // ì»¤ìŠ¤í…€ í…ìŠ¤íŠ¸ í‘œì‹œ
            if (captureText) {
                const fontSize = parseInt(document.getElementById('captureFontSize').value) * scale;
                const textColor = document.getElementById('captureTextColor').value;
                const textPosition = document.getElementById('captureTextPosition').value;
                const textStyle = document.getElementById('captureTextStyle').value;

                previewCtx.font = `bold ${fontSize}px Arial, sans-serif`;
                previewCtx.textAlign = 'center';
                previewCtx.textBaseline = 'middle';

                const x = previewCanvas.width / 2;
                let y;
                const padding = fontSize * 0.8;

                if (textPosition === 'top') {
                    y = padding;
                } else if (textPosition === 'middle') {
                    y = previewCanvas.height / 2;
                } else {
                    y = previewCanvas.height - padding;
                }

                const textMetrics = previewCtx.measureText(captureText);
                const textWidth = textMetrics.width;
                const textHeight = fontSize * 1.4;

                if (textStyle === 'background') {
                    previewCtx.fillStyle = 'rgba(0, 0, 0, 0.6)';
                    previewCtx.fillRect(
                        x - textWidth / 2 - fontSize * 0.5,
                        y - textHeight / 2,
                        textWidth + fontSize,
                        textHeight
                    );
                }

                previewCtx.strokeStyle = '#000000';
                previewCtx.lineWidth = textStyle === 'transparent' ? scale * 4 : scale * 3;
                previewCtx.strokeText(captureText, x, y);

                previewCtx.fillStyle = textColor;
                previewCtx.fillText(captureText, x, y);
            }

            // íƒ€ì„ìŠ¤íƒ¬í”„ í‘œì‹œ
            if (showTimestamp) {
                const formatTime = (seconds) => {
                    const hours = Math.floor(seconds / 3600);
                    const minutes = Math.floor((seconds % 3600) / 60);
                    const secs = Math.floor(seconds % 60);
                    const ms = Math.floor((seconds % 1) * 100);
                    return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(secs).padStart(2, '0')}.${String(ms).padStart(2, '0')}`;
                };

                const timestamp = formatTime(videoPlayer.currentTime || 0);
                const timestampFontSize = 28 * scale;

                previewCtx.font = `bold ${timestampFontSize}px 'Courier New', monospace`;
                previewCtx.textAlign = 'right';
                previewCtx.textBaseline = 'bottom';

                const tsX = previewCanvas.width - timestampFontSize * 0.5;
                const tsY = previewCanvas.height - timestampFontSize * 0.5;

                const tsMetrics = previewCtx.measureText(timestamp);
                const tsWidth = tsMetrics.width;
                const tsHeight = timestampFontSize * 1.2;

                previewCtx.fillStyle = 'rgba(0, 0, 0, 0.7)';
                previewCtx.fillRect(
                    tsX - tsWidth - timestampFontSize * 0.3,
                    tsY - tsHeight + timestampFontSize * 0.2,
                    tsWidth + timestampFontSize * 0.6,
                    tsHeight
                );

                previewCtx.strokeStyle = '#000000';
                previewCtx.lineWidth = scale * 2;
                previewCtx.strokeText(timestamp, tsX, tsY);

                previewCtx.fillStyle = '#FFFFFF';
                previewCtx.fillText(timestamp, tsX, tsY);
            }
        }

        // í”„ë¦¬ë·° ì• ë‹ˆë©”ì´ì…˜ ë£¨í”„
        function animatePreview() {
            updateTextPreview();
            previewAnimationId = requestAnimationFrame(animatePreview);
        }

        // í…ìŠ¤íŠ¸ ì˜µì…˜ ë³€ê²½ ì‹œ í”„ë¦¬ë·° ì—…ë°ì´íŠ¸
        ['captureText', 'captureFontSize', 'captureTextColor', 'captureTextPosition', 'captureTextStyle', 'showTimestamp'].forEach(id => {
            const element = document.getElementById(id);
            if (element) {
                element.addEventListener('input', updateTextPreview);
                element.addEventListener('change', updateTextPreview);
            }
        });

        // ë¹„ë””ì˜¤ ë¡œë“œ ì‹œ í”„ë¦¬ë·° ì‹œì‘
        videoPlayer.addEventListener('loadedmetadata', function() {
            // ê¸°ì¡´ ì• ë‹ˆë©”ì´ì…˜ ì¤‘ì§€
            if (previewAnimationId) {
                cancelAnimationFrame(previewAnimationId);
            }
            // í”„ë¦¬ë·° ì‹œì‘
            animatePreview();
        });

        // ===============================
        // íŒŒì›ŒìŠ¬ë¡œìš° ì¬ìƒ (ì‹¤ì‹œê°„ í”„ë ˆì„ ë³´ê°„ í† ê¸€)
        // ===============================

        let powerSlowState = {
            isActive: false,
            animationId: null,
            speed: 0.25,  // 4ë°° ìŠ¬ë¡œìš°
            quality: 'ultra',
            lastFrameTime: 0,
            prevFrameData: null,
            nextFrameData: null,
            frameCaptureCanvas: null,
            frameCaptureCtx: null,
            interpolationSteps: 4,  // ë‹¨ìˆœ ë³´ê°„ 4ê°œ í”„ë ˆì„ (ë–¨ë¦¼ ë°©ì§€)
            currentStep: 0,
            targetFrameTime: 0,
            wasPlaying: false,
            motionBlurFrames: []  // Motion blurë¥¼ ìœ„í•œ í”„ë ˆì„ ë²„í¼
        };

        // íŒŒì›ŒìŠ¬ë¡œìš° ì¬ìƒ í† ê¸€
        function togglePowerSlowPlayback() {
            // ë¹„ë””ì˜¤ ë¡œë“œ í™•ì¸
            if (!videoPlayer.src || !videoPlayer.duration) {
                showStatus('ë¹„ë””ì˜¤ë¥¼ ë¨¼ì € ë¡œë“œí•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            if (powerSlowState.isActive) {
                // íŒŒì›ŒìŠ¬ë¡œìš° OFF â†’ ì¼ë°˜ ì¬ìƒìœ¼ë¡œ ë³µê·€
                stopPowerSlowPlayback();
            } else {
                // íŒŒì›ŒìŠ¬ë¡œìš° ON â†’ ìŠ¬ë¡œìš° ëª¨ì…˜ ì‹œì‘
                startPowerSlowPlayback();
            }
        }

        // Easing í•¨ìˆ˜ (ease-in-out): ìì—°ìŠ¤ëŸ¬ìš´ ë³´ê°„
        function easeInOutCubic(t) {
            return t < 0.5
                ? 4 * t * t * t
                : 1 - Math.pow(-2 * t + 2, 3) / 2;
        }

        // íŒŒì›ŒìŠ¬ë¡œìš° ì¬ìƒ ì‹œì‘
        function startPowerSlowPlayback() {
            // í’ˆì§ˆì— ë”°ë¥¸ ë³´ê°„ ìŠ¤í… ì„¤ì •
            const speed = 0.25;  // 4ë°° ìŠ¬ë¡œìš° ê³ ì •
            const quality = 'ultra';
            let interpolationSteps = 4;  // ë‹¨ìˆœ ë³´ê°„: 4ê°œ í”„ë ˆì„ (ë–¨ë¦¼ ë°©ì§€)

            // ìƒíƒœ ì´ˆê¸°í™”
            powerSlowState.speed = speed;
            powerSlowState.quality = quality;
            powerSlowState.interpolationSteps = interpolationSteps;
            powerSlowState.currentStep = 0;
            powerSlowState.isActive = true;
            powerSlowState.lastFrameTime = performance.now();
            powerSlowState.targetFrameTime = videoPlayer.currentTime;
            powerSlowState.wasPlaying = !videoPlayer.paused;
            powerSlowState.motionBlurFrames = [];  // ì´ˆê¸°í™”

            // Canvas ì´ˆê¸°í™”
            if (!powerSlowState.frameCaptureCanvas) {
                powerSlowState.frameCaptureCanvas = document.createElement('canvas');
                powerSlowState.frameCaptureCanvas.width = videoPlayer.videoWidth;
                powerSlowState.frameCaptureCanvas.height = videoPlayer.videoHeight;
                powerSlowState.frameCaptureCtx = powerSlowState.frameCaptureCanvas.getContext('2d');
            }

            // ë¹„ë””ì˜¤ ì¼ì‹œì •ì§€ (ìˆ˜ë™ìœ¼ë¡œ í”„ë ˆì„ ì œì–´)
            videoPlayer.pause();

            // í…ìŠ¤íŠ¸ í”„ë¦¬ë·° ì• ë‹ˆë©”ì´ì…˜ ì¤‘ì§€
            if (previewAnimationId) {
                cancelAnimationFrame(previewAnimationId);
                previewAnimationId = null;
            }

            // previewCanvas í‘œì‹œ
            previewCanvas.style.display = 'block';
            previewCanvas.style.position = 'absolute';
            previewCanvas.style.top = '0';
            previewCanvas.style.left = '0';
            previewCanvas.style.zIndex = '10';

            // ì²« í”„ë ˆì„ ìº¡ì²˜
            capturePowerSlowFrame();

            // UI ì—…ë°ì´íŠ¸
            const toggleBtn = document.getElementById('powerSlowToggleBtn');
            toggleBtn.textContent = 'âš¡ íŒŒì›ŒìŠ¬ë¡œìš° ì¬ìƒ ON';
            toggleBtn.style.background = 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)';

            const status = document.getElementById('powerSlowStatus');
            status.textContent = 'ìŠ¬ë¡œìš° ëª¨ì…˜ ì¬ìƒ ì¤‘ (ë‹¤ì‹œ í´ë¦­í•˜ë©´ ì¼ë°˜ ì¬ìƒìœ¼ë¡œ ë³µê·€)';
            status.style.color = '#f5576c';
            status.style.fontWeight = 'bold';

            console.log(`âš¡ íŒŒì›ŒìŠ¬ë¡œìš° ON - ì†ë„: ${speed}x, ë³´ê°„ ìŠ¤í…: ${interpolationSteps}`);
            showStatus('íŒŒì›ŒìŠ¬ë¡œìš° ì¬ìƒ ON', 'success');

            // ë Œë”ë§ ë£¨í”„ ì‹œì‘
            powerSlowRenderLoop();
        }

        // íŒŒì›ŒìŠ¬ë¡œìš° ì¬ìƒ ì •ì§€
        function stopPowerSlowPlayback() {
            if (powerSlowState.animationId) {
                cancelAnimationFrame(powerSlowState.animationId);
                powerSlowState.animationId = null;
            }

            powerSlowState.isActive = false;
            powerSlowState.prevFrameData = null;
            powerSlowState.nextFrameData = null;

            // previewCanvas ìŠ¤íƒ€ì¼ ë³µì› (í…ìŠ¤íŠ¸ í”„ë¦¬ë·°ë¡œ ë³µê·€)
            previewCanvas.style.position = '';
            previewCanvas.style.top = '';
            previewCanvas.style.left = '';
            previewCanvas.style.zIndex = '';

            // ë¹„ë””ì˜¤ ì¬ìƒ ë³µê·€ (ì´ì „ ìƒíƒœê°€ ì¬ìƒ ì¤‘ì´ì—ˆë‹¤ë©´)
            if (powerSlowState.wasPlaying) {
                videoPlayer.play();
            }

            // í…ìŠ¤íŠ¸ í”„ë¦¬ë·° ì• ë‹ˆë©”ì´ì…˜ ì¬ì‹œì‘
            if (!previewAnimationId) {
                animatePreview();
            }

            // UI ì—…ë°ì´íŠ¸
            const toggleBtn = document.getElementById('powerSlowToggleBtn');
            toggleBtn.textContent = 'âš¡ íŒŒì›ŒìŠ¬ë¡œìš° ì¬ìƒ OFF';
            toggleBtn.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';

            const status = document.getElementById('powerSlowStatus');
            status.textContent = 'ì¬ìƒ ì¤‘ ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ì‹¤ì‹œê°„ ìŠ¬ë¡œìš° ëª¨ì…˜ (4ë°° ìŠ¬ë¡œìš°, ë‹¨ìˆœ ë³´ê°„ 4ê°œ í”„ë ˆì„)';
            status.style.color = '#666';
            status.style.fontWeight = 'normal';

            console.log('âš¡ íŒŒì›ŒìŠ¬ë¡œìš° OFF');
            showStatus('íŒŒì›ŒìŠ¬ë¡œìš° ì¬ìƒ OFF', 'info');
        }

        // íŒŒì›ŒìŠ¬ë¡œìš° í”„ë ˆì„ ìº¡ì²˜
        function capturePowerSlowFrame() {
            if (!powerSlowState.isActive) return;

            const ctx = powerSlowState.frameCaptureCtx;
            const canvas = powerSlowState.frameCaptureCanvas;

            // í˜„ì¬ ë¹„ë””ì˜¤ í”„ë ˆì„ ìº¡ì²˜
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.filter = getCurrentFilterString();
            ctx.drawImage(videoPlayer, 0, 0, canvas.width, canvas.height);
            ctx.filter = 'none';

            // ì´ë¯¸ì§€ ë°ì´í„° ì €ì¥
            return ctx.getImageData(0, 0, canvas.width, canvas.height);
        }

        // íŒŒì›ŒìŠ¬ë¡œìš° ë Œë”ë§ ë£¨í”„
        function powerSlowRenderLoop(timestamp) {
            if (!powerSlowState.isActive) return;

            const now = performance.now();
            const elapsed = now - powerSlowState.lastFrameTime;

            // í”„ë ˆì„ ê°„ê²© ê³„ì‚° (60fps ê¸°ì¤€)
            const frameInterval = 1000 / 60;

            if (elapsed >= frameInterval) {
                powerSlowState.lastFrameTime = now;

                // í”„ë ˆì„ ë³´ê°„ ë Œë”ë§
                renderPowerSlowFrame();

                // ë‹¤ìŒ ìŠ¤í…ìœ¼ë¡œ
                powerSlowState.currentStep++;

                if (powerSlowState.currentStep >= powerSlowState.interpolationSteps) {
                    // ë‹¤ìŒ ì›ë³¸ í”„ë ˆì„ìœ¼ë¡œ ì´ë™
                    powerSlowState.currentStep = 0;

                    // ë¹„ë””ì˜¤ ì‹œê°„ ì§„í–‰ (ìŠ¬ë¡œìš° ì†ë„ ì ìš©)
                    const frameDuration = 1 / 30; // 30fps ê¸°ì¤€
                    powerSlowState.targetFrameTime += frameDuration;

                    // ë¹„ë””ì˜¤ ë ì²´í¬
                    if (powerSlowState.targetFrameTime >= videoPlayer.duration) {
                        stopPowerSlowPlayback();
                        return;
                    }

                    // ë‹¤ìŒ í”„ë ˆì„ìœ¼ë¡œ seek
                    videoPlayer.currentTime = powerSlowState.targetFrameTime;

                    // ìƒˆ í”„ë ˆì„ ìº¡ì²˜ ëŒ€ê¸°
                    const seekHandler = () => {
                        videoPlayer.removeEventListener('seeked', seekHandler);
                        // ìƒˆ í”„ë ˆì„ ìº¡ì²˜ ì¤€ë¹„
                        powerSlowState.prevFrameData = powerSlowState.nextFrameData;
                        powerSlowState.nextFrameData = capturePowerSlowFrame();
                    };
                    videoPlayer.addEventListener('seeked', seekHandler);
                }
            }

            powerSlowState.animationId = requestAnimationFrame(powerSlowRenderLoop);
        }

        // íŒŒì›ŒìŠ¬ë¡œìš° í”„ë ˆì„ ë Œë”ë§ (ê°œì„ : Easing + Motion Blur)
        function renderPowerSlowFrame() {
            if (!powerSlowState.prevFrameData || !powerSlowState.nextFrameData) {
                // ì²« í”„ë ˆì„: í˜„ì¬ í”„ë ˆì„ë§Œ í‘œì‹œ
                previewCtx.clearRect(0, 0, previewCanvas.width, previewCanvas.height);
                previewCtx.imageSmoothingEnabled = true;
                previewCtx.imageSmoothingQuality = 'high';
                previewCtx.drawImage(videoPlayer, 0, 0, previewCanvas.width, previewCanvas.height);

                // ì´ˆê¸° í”„ë ˆì„ ë°ì´í„° ì„¤ì •
                if (!powerSlowState.prevFrameData) {
                    powerSlowState.prevFrameData = capturePowerSlowFrame();
                }
                if (!powerSlowState.nextFrameData) {
                    powerSlowState.nextFrameData = powerSlowState.prevFrameData;
                }
                return;
            }

            // Linear alpha
            const linearAlpha = powerSlowState.currentStep / powerSlowState.interpolationSteps;

            // Easing ì ìš©: ìì—°ìŠ¤ëŸ¬ìš´ ê°€ì†/ê°ì† (ease-in-out)
            const easedAlpha = easeInOutCubic(linearAlpha);

            // previewCanvas í¬ê¸° ì„¤ì •
            previewCanvas.width = videoPlayer.videoWidth;
            previewCanvas.height = videoPlayer.videoHeight;

            // ê³ í’ˆì§ˆ ë Œë”ë§ ì„¤ì •
            previewCtx.imageSmoothingEnabled = true;
            previewCtx.imageSmoothingQuality = 'high';

            // ë‹¨ìˆœ Alpha Blending (Motion Blur ì œê±°)
            const blurStrength = 0;  // ë¸”ëŸ¬ ì œê±°
            const blurLayers = 1;  // ë‹¨ì¼ ë ˆì´ì–´ (ë–¨ë¦¼ ë°©ì§€)

            previewCtx.clearRect(0, 0, previewCanvas.width, previewCanvas.height);

            // ì„ì‹œ canvasë¡œ ë¸”ë Œë”©
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = previewCanvas.width;
            tempCanvas.height = previewCanvas.height;
            const tempCtx = tempCanvas.getContext('2d', { alpha: true });
            tempCtx.imageSmoothingEnabled = true;
            tempCtx.imageSmoothingQuality = 'high';

            // Motion blur: ì—¬ëŸ¬ ë ˆì´ì–´ë¥¼ ê²¹ì³ì„œ ë¸”ëŸ¬ íš¨ê³¼
            for (let layer = 0; layer < blurLayers; layer++) {
                const layerOffset = (layer - Math.floor(blurLayers / 2)) * blurStrength;
                const layerAlpha = Math.max(0, Math.min(1, easedAlpha + layerOffset));

                // Prev í”„ë ˆì„ ë ˆì´ì–´
                tempCtx.clearRect(0, 0, tempCanvas.width, tempCanvas.height);
                tempCtx.putImageData(powerSlowState.prevFrameData, 0, 0);

                const prevWeight = (1 - layerAlpha) / blurLayers;
                previewCtx.globalAlpha = prevWeight;
                previewCtx.drawImage(tempCanvas, 0, 0);

                // Next í”„ë ˆì„ ë ˆì´ì–´
                tempCtx.clearRect(0, 0, tempCanvas.width, tempCanvas.height);
                tempCtx.putImageData(powerSlowState.nextFrameData, 0, 0);

                const nextWeight = layerAlpha / blurLayers;
                previewCtx.globalAlpha = nextWeight;
                previewCtx.drawImage(tempCanvas, 0, 0);
            }

            // ë³µì›
            previewCtx.globalAlpha = 1.0;

            // ë””ë²„ê·¸ ì •ë³´ í‘œì‹œ (ê°„í—ì )
            if (powerSlowState.currentStep % 12 === 0) {
                console.log(`âš¡ í”„ë ˆì„ ë³´ê°„: Linear ${(linearAlpha * 100).toFixed(0)}% â†’ Eased ${(easedAlpha * 100).toFixed(0)}% (ìŠ¤í… ${powerSlowState.currentStep}/${powerSlowState.interpolationSteps})`);
            }
        }

        // ë¹„ë””ì˜¤ ì¼ì‹œì •ì§€/ì¬ìƒ ì‹œì—ë„ ë¯¸ë¦¬ë³´ê¸° ìœ ì§€
        videoPlayer.addEventListener('pause', updateTextPreview);
        videoPlayer.addEventListener('play', updateTextPreview);
        videoPlayer.addEventListener('seeked', updateTextPreview);

        // ë¹„ë””ì˜¤ ì—ëŸ¬ ì²˜ë¦¬
        videoPlayer.addEventListener('error', function(e) {
            showStatus('ë¹„ë””ì˜¤ ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            console.error('Video error:', e);
        });

        // ë¹„ë””ì˜¤ í´ë¦­ ì‹œ ì¼ì‹œì •ì§€ ì²˜ë¦¬
        videoPlayer.addEventListener('mousedown', function(e) {
            // controlsì˜ ë²„íŠ¼ í´ë¦­ì´ ì•„ë‹Œ ê²½ìš°
            if (e.target === videoPlayer) {
                allowPlay = false;
                if (!videoPlayer.paused) {
                    videoPlayer.pause();
                }
            } else {
                // controls ë²„íŠ¼ í´ë¦­ì€ í—ˆìš©
                allowPlay = true;
            }
        });

        // click ì´ë²¤íŠ¸ì˜ ê¸°ë³¸ ë™ì‘ ì°¨ë‹¨
        videoPlayer.addEventListener('click', function(e) {
            if (e.target === videoPlayer) {
                e.preventDefault();
                e.stopPropagation();
            }
        }, true);

        // play ì´ë²¤íŠ¸ ê°ì§€í•˜ì—¬ í´ë¦­ìœ¼ë¡œ ì¸í•œ ì¬ìƒ ì°¨ë‹¨
        videoPlayer.addEventListener('play', function(e) {
            if (!allowPlay) {
                videoPlayer.pause();
            }
            allowPlay = true;
        });

        // ============================================
        // ë¹„ë””ì˜¤ ê°¤ëŸ¬ë¦¬ ê¸°ëŠ¥
        // ============================================

        // ë¹„ë””ì˜¤ í´ë” ì—´ê¸°
        async function openVideoFolder() {
            try {
                // File System Access APIë¡œ í´ë” ì„ íƒ
                videoFolderHandle = await window.showDirectoryPicker({
                    mode: 'read'
                });

                showStatus('í´ë” ìŠ¤ìº” ì¤‘...', 'info');
                showProgress(0);

                // í´ë” ë‚´ ë¹„ë””ì˜¤ íŒŒì¼ ìŠ¤ìº”
                await scanVideoFiles();

                hideProgress();
                showStatus(`${videoFiles.length}ê°œì˜ ë¹„ë””ì˜¤ë¥¼ ì°¾ì•˜ìŠµë‹ˆë‹¤!`, 'success');

            } catch (error) {
                if (error.name !== 'AbortError') {
                    console.error('í´ë” ì—´ê¸° ì˜¤ë¥˜:', error);
                    showStatus('í´ë”ë¥¼ ì—´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
                }
                hideProgress();
            }
        }

        // í´ë” ë‚´ ë¹„ë””ì˜¤ íŒŒì¼ ìŠ¤ìº”
        async function scanVideoFiles() {
            videoFiles = [];
            const videoExtensions = ['.mp4', '.webm', '.avi', '.mov', '.mkv', '.m4v', '.flv'];

            for await (const entry of videoFolderHandle.values()) {
                if (entry.kind === 'file') {
                    const fileName = entry.name.toLowerCase();
                    const hasVideoExtension = videoExtensions.some(ext => fileName.endsWith(ext));

                    if (hasVideoExtension) {
                        const file = await entry.getFile();
                        videoFiles.push({
                            fileHandle: entry,
                            file: file,
                            name: entry.name,
                            size: file.size,
                            thumbnail: null
                        });
                    }
                }
            }

            // ì´ë¦„ìˆœ ì •ë ¬
            videoFiles.sort((a, b) => a.name.localeCompare(b.name));

            // ê°¤ëŸ¬ë¦¬ í‘œì‹œ
            await displayVideoGallery();
        }

        // ë¹„ë””ì˜¤ ê°¤ëŸ¬ë¦¬ í‘œì‹œ
        async function displayVideoGallery() {
            const galleryDiv = document.getElementById('videoGallery');
            const gridDiv = document.getElementById('videoGrid');
            const countDiv = document.getElementById('galleryCount');

            if (videoFiles.length === 0) {
                galleryDiv.style.display = 'none';
                return;
            }

            // ê°¤ëŸ¬ë¦¬ í‘œì‹œ
            galleryDiv.style.display = 'block';
            countDiv.textContent = `${videoFiles.length}ê°œ ë¹„ë””ì˜¤`;
            gridDiv.innerHTML = '';

            // ê° ë¹„ë””ì˜¤ ì¹´ë“œ ìƒì„±
            for (let i = 0; i < videoFiles.length; i++) {
                const videoInfo = videoFiles[i];

                // ì¹´ë“œ ìƒì„±
                const card = document.createElement('div');
                card.className = 'video-card';
                card.onclick = () => loadVideoFromGallery(i);

                // ì¸ë„¤ì¼ ìƒì„± (ë¹„ë™ê¸°)
                const thumbnailUrl = await generateVideoThumbnail(videoInfo.file);

                card.innerHTML = `
                    <img class="video-thumbnail" src="${thumbnailUrl}" alt="${videoInfo.name}">
                    <div class="video-info">
                        <div class="video-name" title="${videoInfo.name}">${videoInfo.name}</div>
                        <div class="video-duration">${formatFileSize(videoInfo.size)}</div>
                    </div>
                `;

                gridDiv.appendChild(card);

                // ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
                showProgress((i + 1) / videoFiles.length * 100);
            }

            hideProgress();
        }

        // ë¹„ë””ì˜¤ ì¸ë„¤ì¼ ìƒì„±
        async function generateVideoThumbnail(file) {
            return new Promise((resolve, reject) => {
                const video = document.createElement('video');
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');

                video.preload = 'metadata';
                video.muted = true;
                video.playsInline = true;

                video.onloadedmetadata = function() {
                    // 1ì´ˆ ì§€ì ìœ¼ë¡œ ì´ë™ (ë˜ëŠ” ë¹„ë””ì˜¤ ì¤‘ê°„)
                    video.currentTime = Math.min(1, video.duration / 2);
                };

                video.onseeked = function() {
                    // ì¸ë„¤ì¼ í¬ê¸° ì„¤ì • (ë¹„ìœ¨ ìœ ì§€)
                    const aspectRatio = video.videoWidth / video.videoHeight;
                    canvas.width = 200;
                    canvas.height = 200 / aspectRatio;

                    // ë¹„ë””ì˜¤ í”„ë ˆì„ ìº¡ì²˜
                    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

                    // Data URLë¡œ ë³€í™˜
                    const thumbnailUrl = canvas.toDataURL('image/jpeg', 0.8);

                    // ì •ë¦¬
                    URL.revokeObjectURL(video.src);
                    resolve(thumbnailUrl);
                };

                video.onerror = function() {
                    // ê¸°ë³¸ ì´ë¯¸ì§€ ë°˜í™˜
                    resolve('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="200" height="120"><rect fill="%23e9ecef" width="200" height="120"/><text x="50%" y="50%" text-anchor="middle" fill="%23999" font-size="16">ğŸ¬</text></svg>');
                };

                // ë¹„ë””ì˜¤ ë¡œë“œ
                video.src = URL.createObjectURL(file);
            });
        }

        // ê°¤ëŸ¬ë¦¬ì—ì„œ ë¹„ë””ì˜¤ ë¡œë“œ
        async function loadVideoFromGallery(index) {
            if (index < 0 || index >= videoFiles.length) return;

            selectedVideoIndex = index;
            const videoInfo = videoFiles[index];

            // ì„ íƒ ìƒíƒœ ì—…ë°ì´íŠ¸
            const cards = document.querySelectorAll('.video-card');
            cards.forEach((card, i) => {
                if (i === index) {
                    card.classList.add('selected');
                } else {
                    card.classList.remove('selected');
                }
            });

            // ë¹„ë””ì˜¤ ë¡œë“œ
            currentVideoFile = videoInfo.file;
            const url = URL.createObjectURL(videoInfo.file);
            videoPlayer.src = url;
            videoPlayer.load();

            showStatus(`${videoInfo.name} ë¡œë“œ ì™„ë£Œ!`, 'success');
        }

        // íŒŒì¼ í¬ê¸° í¬ë§·íŒ…
        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            if (bytes < 1024 * 1024 * 1024) return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
            return (bytes / (1024 * 1024 * 1024)).toFixed(1) + ' GB';
        }
    </script>
</body>
</html>
